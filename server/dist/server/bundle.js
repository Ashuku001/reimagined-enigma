(()=>{var e={9521:(e,t,n)=>{n(818).config(),e.exports={development:{host:process.env.PG_HOST,username:process.env.PG_USERNAME,password:process.env.PG_PASSWORD,database:process.env.PG_DB,dialect:"postgres",pool:{max:5,min:0,acquire:3e4,idle:1e4}},production:{host:process.env.PG_HOST,username:process.env.PG_USERNAME,password:process.env.PG_PASSWORD,database:process.env.PG_DB,logging:!1,dialect:"postgres",pool:{max:5,min:0,acquire:3e4,idle:1e4}}}},3482:(e,t,n)=>{var r=n(9031).Sequelize,a=n(9521),o=n(3793);o=o.db;var s=a.production,i=new r(s.database,s.username,s.password,s),c={models:o(i),sequelize:i};t&&(t.db=c,t.sequelize=i)},618:(e,t,n)=>{var r=n(5124),a=[new r.transports.File({filename:"error.log",level:"error"}),new r.transports.File({filename:"combined.log",level:"verbose"})],o=r.createLogger({level:"info",format:r.format.json(),transports:a});t&&(t.logger=o)},8412:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Merchant,{foreignKey:"merchantId"}),this.belongsTo(e.AdTemplate,{foreignKey:"templateId"}),this.hasMany(e.Message,{foreignKey:"adId",as:"messageAd"})}}]),t}(d);return n.init({merchantId:t.INTEGER,templateId:t.INTEGER,read:t.INTEGER,delivered:t.INTEGER,sent:t.INTEGER,failed:t.INTEGER,response:t.INTEGER},{sequelize:e,modelName:"Ad"}),n}},718:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Merchant,{foreignKey:"merchantId"}),this.hasMany(e.Ad,{foreignKey:"templateId",as:"ads"}),this.hasMany(e.MarketingResponse,{foreignKey:"adTemplateId",as:"adTempResponses"}),this.belongsTo(e.Product,{foreignKey:"productId",as:"adTempProduct"}),this.belongsTo(e.Message,{foreignKey:"messageId",as:"adTempMessage"})}}]),t}(d);return n.init({merchantId:t.INTEGER,name:t.STRING,leads:t.INTEGER,messageId:t.INTEGER,productId:t.INTEGER},{sequelize:e,modelName:"AdTemplate"}),n}},354:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId"}),this.hasMany(e.Category,{foreignKey:"billboardId"})}}]),t}(d);return n.init({storeId:t.INTEGER,label:t.STRING,imageUrl:t.STRING},{sequelize:e,modelName:"Billboard"}),n}},3620:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId"}),this.hasMany(e.Product,{foreignKey:"brandId",as:"brand"})}}]),t}(d);return n.init({name:t.STRING,joinDate:t.DATE,description:t.TEXT,phoneNumber:t.STRING,industry:t.STRING,loc_name:t.STRING,loc_address:t.STRING,loc_latitude:t.STRING,loc_longitude:t.STRING,loc_url:t.STRING,storeId:t.INTEGER},{sequelize:e,modelName:"Brand"}),n}},7190:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.ScheduleTask,{foreignKey:"scheduleTaskId",as:"bulkTempTask"})}}]),t}(d);return n.init({scheduleTaskId:t.INTEGER,message:t.TEXT,template:t.TEXT,customers:t.TEXT},{sequelize:e,modelName:"BulkTemplateTask"}),n}},8438:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveButton,{foreignKey:"interactiveButtonId",as:"buttonReply"}),this.belongsTo(e.Message,{foreignKey:"messageId",as:"mesBtnReply"})}}]),t}(d);return n.init({interactiveButtonId:t.INTEGER,messageId:t.INTEGER,buttonId:t.STRING,title:t.STRING},{sequelize:e,modelName:"ButtonRepliedAction"}),n}},6171:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveButton,{foreignKey:"interactiveButtonId",as:"buttons"})}}]),t}(d);return n.init({interactiveButtonId:t.INTEGER,buttonId:t.STRING,title:t.STRING},{sequelize:e,modelName:"ButtonReplyAction"}),n}},205:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId"}),this.belongsTo(e.Billboard,{foreignKey:"billboardId"}),this.hasMany(e.Product,{foreignKey:"categoryId"})}}]),t}(d);return n.init({storeId:t.INTEGER,billboardId:t.INTEGER,name:t.STRING},{sequelize:e,modelName:"Category"}),n}},491:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Merchant,{foreignKey:"merchantId"}),this.belongsTo(e.Customer,{foreignKey:"customerId"}),this.hasMany(e.Message,{foreignKey:"chatId",as:"messages"}),this.hasMany(e.Conversation,{foreignKey:"chatId",as:"conversations"})}}]),t}(d);return n.init({merchantId:t.INTEGER,customerId:t.INTEGER},{sequelize:e,modelName:"Chat"}),n}},6002:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Chat,{foreignKey:"chatId",as:"conversations"})}}]),t}(d);return n.init({chatId:t.INTEGER,category:t.ENUM(["marketing","utility","service","authentication"]),expiryDate:t.DATE,status:t.STRING,conversationId:t.STRING,pricingModel:t.STRING},{sequelize:e,modelName:"Conversation"}),n}},2171:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Promotion,{foreignKey:"promotionId",as:"coupon"})}}]),t}(d);return n.init({code:t.STRING,validFrom:t.DATE,validTo:t.DATE,discount:t.DECIMAL,active:t.BOOLEAN,promotionId:t.INTEGER},{sequelize:e,modelName:"Coupon"}),n}},1469:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Merchant,{foreignKey:"merchantId"}),this.hasOne(e.Chat,{foreignKey:"customerId"}),this.hasMany(e.Message,{foreignKey:"customerId"}),this.hasOne(e.MarketingResponse,{foreignKey:"customerId",as:"customerLead"}),this.hasMany(e.Order,{foreignKey:"customerId",as:"customerOrder"}),this.hasOne(e.Loyalty,{foreignKey:"customerId",as:"customerLoyalty"}),this.hasMany(e.Purchase,{foreignKey:"customerId",as:"customerPurchases"}),this.hasMany(e.Redemption,{foreignKey:"customerId",as:"customerRedemptions"}),this.belongsToMany(e.Promotion,{through:{model:"PromotionCustomers"},as:"customerPromotions",foreignKey:"customerId",otherKey:"promotionId"}),this.hasMany(e.Sale,{foreignKey:"customerId",as:"customerSales"})}}]),t}(d);return n.init({whatsapp_name:t.STRING,phone_number:t.STRING,first_name:t.STRING,last_name:t.STRING,loc_name:t.STRING,loc_address:t.STRING,zipcode:t.STRING,loc_latitude:t.STRING,loc_longitude:t.STRING,loc_url:t.STRING,merchantId:t.INTEGER,age:t.INTEGER,gender:t.ENUM(["male","female","not_sure"]),income:t.ENUM(["high","low","middle"]),customerSegment:t.ENUM(["corporate","small","middle","individual"]),occupation:t.ENUM(["student","employed","self_employed"]),joinDate:t.DATE,lastPromoted:t.DATE,status:t.ENUM(["new","high_rated","medium_rated","low_rated"])},{sequelize:e,modelName:"Customer"}),n}},9673:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Message,{foreignKey:"messageId",as:"document"})}}]),t}(d);return n.init({caption:t.TEXT,mimeType:t.STRING,sha256:t.STRING,filename:t.STRING,url:t.STRING,documentId:t.STRING,messageId:t.INTEGER},{sequelize:e,modelName:"DocumentMessage"}),n}},980:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Product,{foreignKey:"productId"})}}]),t}(d);return n.init({productId:t.INTEGER,storeId:t.INTEGER,url:t.STRING},{sequelize:e,modelName:"Image"}),n}},9921:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveButton,{foreignKey:"interactiveButtonId",as:"btnImageHead"}),this.belongsTo(e.InteractiveTemplate,{foreignKey:"interactiveTemplateId",as:"tempImageHead"})}}]),t}(d);return n.init({interactiveButtonId:t.INTEGER,interactiveTemplateId:t.INTEGER,link:t.STRING},{sequelize:e,modelName:"ImageHeader"}),n}},9833:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Message,{foreignKey:"messageId",as:"image"})}}]),t}(d);return n.init({caption:t.TEXT,mimeType:t.STRING,sha256:t.STRING,url:t.STRING,imageId:t.STRING,AWbucketId:t.STRING,AWfileId:t.STRING,messageId:t.INTEGER},{sequelize:e,modelName:"ImageMessage"}),n}},3793:(e,t,n)=>{var r=n(9031);n(818).config(),t&&(t.db=function(e){var t={},a=n(3963);return a.keys().map(a).forEach((function(n){var a=n(e,r);t[a.name]=a})),Object.keys(t).forEach((function(e){t[e].associate&&t[e].associate(t)})),t})},5117:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveMessage,{foreignKey:"interactiveMesId",as:"button"}),this.hasOne(e.ImageHeader,{foreignKey:"interactiveButtonId",as:"btnImageHead"}),this.hasOne(e.TextHeader,{foreignKey:"interactiveButtonId",as:"btnTextHead"}),this.hasMany(e.ButtonReplyAction,{foreignKey:"interactiveButtonId",as:"buttons"}),this.hasOne(e.ButtonRepliedAction,{foreignKey:"interactiveButtonId",as:"buttonReply"}),this.belongsTo(e.Product,{foreignKey:"productId",as:"product"})}}]),t}(d);return n.init({interactiveMesId:t.INTEGER,header:t.ENUM(["TEXT","IMAGE","VIDEO","DOCUMENT"]),body:t.TEXT,action:t.ENUM(["BUTTON_REPLY"]),productId:t.INTEGER,footer:t.STRING},{sequelize:e,modelName:"InteractiveButton"}),n}},2193:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveMessage,{foreignKey:"interactiveMesId",as:"list"}),this.hasMany(e.ListSection,{foreignKey:"interactiveListId",as:"sections"}),this.hasOne(e.TextHeader,{foreignKey:"interactiveListId",as:"listTextHead"})}}]),t}(d);return n.init({interactiveMesId:t.INTEGER,header:t.ENUM(["TEXT"]),body:t.TEXT,footer:t.STRING,button:t.STRING},{sequelize:e,modelName:"InteractiveList"}),n}},8194:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Message,{foreignKey:"messageId",as:"interactive"}),this.hasOne(e.InteractiveButton,{foreignKey:"interactiveMesId",as:"button"}),this.hasOne(e.InteractiveList,{foreignKey:"interactiveMesId",as:"list"}),this.hasOne(e.InteractiveTemplate,{foreignKey:"interactiveMesId",as:"template"})}}]),t}(d);return n.init({messageId:t.INTEGER,type:t.ENUM(["BUTTON","LIST","TEMPLATE"])},{sequelize:e,modelName:"InteractiveMessage"}),n}},2163:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveMessage,{foreignKey:"interactiveMesId",as:"template"}),this.hasOne(e.ImageHeader,{foreignKey:"interactiveTemplateId",as:"tempImageHead"}),this.hasOne(e.TextHeader,{foreignKey:"interactiveTemplateId",as:"tempTextHead"}),this.belongsTo(e.Product,{foreignKey:"productId",as:"tempProduct"}),this.hasOne(e.TemplateRepliedAction,{foreignKey:"interactiveTemplateId",as:"tempReply"}),this.hasMany(e.TemplateReplyAction,{foreignKey:"interactiveTemplateId",as:"buttons"})}}]),t}(d);return n.init({interactiveMesId:t.INTEGER,header:t.ENUM(["TEXT","IMAGE","VIDEO","DOCUMENT","LOCATION"]),body:t.TEXT,footer:t.STRING,action:t.STRING,productId:t.INTEGER},{sequelize:e,modelName:"InteractiveTemplate"}),n}},3002:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.ListRowButton,{foreignKey:"listRowButtonId",as:"listReply"}),this.belongsTo(e.Message,{foreignKey:"messageId",as:"mesListReply"})}}]),t}(d);return n.init({listRowButtonId:t.INTEGER,messageId:t.INTEGER,buttonId:t.STRING,title:t.STRING,description:t.STRING},{sequelize:e,modelName:"ListRepliedAction"}),n}},8525:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.ListSection,{foreignKey:"listSectionId",as:"rows"}),this.belongsTo(e.Product,{foreignKey:"productId",as:"product"}),this.hasOne(e.ListRepliedAction,{foreignKey:"listRowButtonId",as:"listReply"})}}]),t}(d);return n.init({listSectionId:t.INTEGER,productId:t.INTEGER,buttonId:t.STRING,title:t.STRING,description:t.STRING},{sequelize:e,modelName:"ListRowButton"}),n}},226:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveList,{foreignKey:"interactiveListId",as:"sections"}),this.hasMany(e.ListRowButton,{foreignKey:"listSectionId",as:"rows"})}}]),t}(d);return n.init({interactiveListId:t.INTEGER,title:t.STRING},{sequelize:e,modelName:"ListSection"}),n}},6007:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Message,{foreignKey:"messageId",as:"location"})}}]),t}(d);return n.init({address:t.STRING,latitude:t.STRING,longitude:t.STRING,name:t.STRING,url:t.STRING,messageId:t.INTEGER},{sequelize:e,modelName:"LocationMessage"}),n}},8783:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Customer,{foreignKey:"customerId",as:"customerLoyalty"})}}]),t}(d);return n.init({customerId:t.INTEGER,pointsBalance:t.INTEGER,lastUpdated:t.DATE},{sequelize:e,modelName:"Loyalty"}),n}},4674:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Customer,{foreignKey:"customerId",as:"cusTempLead"}),this.belongsTo(e.Message,{foreignKey:"messageId",as:"mesTempLead"}),this.belongsTo(e.Product,{foreignKey:"productId",as:"prodTempLead"}),this.belongsTo(e.AdTemplate,{foreignKey:"adTemplateId",as:"adTempResponses"})}}]),t}(d);return n.init({customerId:t.INTEGER,adTemplateId:t.INTEGER,messageId:t.INTEGER,productId:t.INTEGER,score:t.INTEGER},{sequelize:e,modelName:"MarketingResponse"}),n}},3785:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.hasMany(e.Customer,{as:"customers",foreignKey:"merchantId"}),this.hasMany(e.Chat,{foreignKey:"merchantId"}),this.hasMany(e.Ad,{foreignKey:"merchantId"}),this.hasMany(e.AdTemplate,{foreignKey:"merchantId"}),this.hasOne(e.Setting,{foreignKey:"merchantId"}),this.hasMany(e.Message,{foreignKey:"merchantId"}),this.hasMany(e.Store,{as:"merchatsStore",foreignKey:"merchantId"}),this.hasMany(e.ScheduleTask,{foreignKey:"merchantId",as:"merchantsTasks"})}}]),t}(d);return n.init({business_name:t.STRING,username:t.STRING,password:t.STRING,email:t.STRING,whatsapp_phone_number:t.STRING},{sequelize:e,modelName:"Merchant"}),n}},3050:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Chat,{foreignKey:"chatId"}),this.hasOne(e.TextMessage,{foreignKey:"messageId",as:"text"}),this.hasOne(e.ImageMessage,{foreignKey:"messageId",as:"image"}),this.hasOne(e.LocationMessage,{foreignKey:"messageId",as:"location"}),this.hasOne(e.VideoMessage,{foreignKey:"messageId",as:"video"}),this.hasOne(e.DocumentMessage,{foreignKey:"messageId",as:"document"}),this.hasOne(e.InteractiveMessage,{foreignKey:"messageId",as:"interactive"}),this.hasOne(e.ButtonRepliedAction,{foreignKey:"messageId",as:"mesBtnReply"}),this.hasOne(e.ListRepliedAction,{foreignKey:"messageId",as:"mesListReply"}),this.hasOne(e.TemplateRepliedAction,{foreignKey:"messageId",as:"mesTempReply"}),this.belongsTo(e.Ad,{foreignKey:"adId",as:"messageAd"}),this.hasOne(e.MarketingResponse,{foreignKey:"messageId",as:"mesTempLead"}),this.hasOne(e.AdTemplate,{foreignKey:"messageId",as:"adTempMessage"}),this.hasMany(e.Message,{foreignKey:"contextId",as:"contexts"}),this.belongsTo(e.Message,{foreignKey:"contextId",as:"context"}),this.belongsTo(e.Merchant,{foreignKey:"merchantId"}),this.belongsTo(e.Customer,{foreignKey:"customerId"})}}]),t}(d);return n.init({from_customer:t.BOOLEAN,timestamp:t.DATE,type:t.ENUM(["TEXT","VIDEO","IMAGE","DOCUMENT","LOCATION","LOCATION","INTERACTIVE","BUTTON_REPLY","LIST_REPLY","TEMPLATE_REPLY"]),isAd:t.BOOLEAN,chatId:t.INTEGER,adId:t.INTEGER,customerId:t.INTEGER,merchantId:t.INTEGER,hasContext:t.BOOLEAN,contextId:t.INTEGER,messageId:t.STRING,status:t.ENUM(["read","delivered","sent"])},{sequelize:e,modelName:"Message"}),n}},1849:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId",as:"mpesa"})}}]),t}(d);return n.init({consumer_key:t.STRING,consumer_secret:t.STRING,pass_key:t.STRING,business_shortcode:t.STRING,account_reference:t.STRING,transaction_desc:t.STRING,callback_url:t.STRING,storeId:t.INTEGER},{sequelize:e,modelName:"MpesaSetting"}),n}},6125:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId",as:"storeOrder"}),this.hasMany(e.OrderItem,{foreignKey:"orderId",as:"orderItems",onUpdate:"CASCADE"}),this.belongsTo(e.Customer,{foreignKey:"customerId",as:"customerOrder"})}}]),t}(d);return n.init({isPaid:t.BOOLEAN,orderID:t.STRING,status:t.ENUM(["CONFIRMED","PENDING","RECEIVED"]),phone:t.STRING,address:t.STRING,storeId:t.INTEGER,customerId:t.INTEGER},{sequelize:e,modelName:"Order"}),n}},5682:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Order,{foreignKey:"orderId",as:"orderItems",onUpdate:"CASCADE"}),this.belongsTo(e.Product,{foreignKey:"productId",as:"orderProduct"})}}]),t}(d);return n.init({orderId:t.INTEGER,price:t.DECIMAL,quantity:t.INTEGER,productId:t.INTEGER},{sequelize:e,modelName:"OrderItem"}),n}},1506:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId"}),this.belongsTo(e.Category,{foreignKey:"categoryId"}),this.hasMany(e.Image,{foreignKey:"productId",as:"images"}),this.hasOne(e.OrderItem,{foreignKey:"productId",as:"orderProduct"}),this.hasMany(e.InteractiveButton,{foreignKey:"productId",as:"product"}),this.hasMany(e.InteractiveTemplate,{foreignKey:"productId",as:"tempProduct"}),this.hasMany(e.ListRowButton,{foreignKey:"productId",as:"listProduct"}),this.hasMany(e.MarketingResponse,{foreignKey:"productId",as:"productLead"}),this.hasMany(e.AdTemplate,{foreignKey:"productId",as:"adTempProduct"}),this.belongsTo(e.Brand,{foreignKey:"brandId",as:"brand"}),this.hasMany(e.ProductVariation,{foreignKey:"productId",as:"prodVariations"}),this.hasMany(e.ProductCombination,{foreignKey:"productId",as:"prodCombinations"}),this.belongsToMany(e.Promotion,{through:{model:"PromotionProducts"},as:"promotionProducts",foreignKey:"promotionId",otherKey:"productId"}),this.hasMany(e.SaleDetail,{foreignKey:"productId",as:"productSales"})}}]),t}(d);return n.init({name:t.STRING,price:t.DECIMAL,description:t.TEXT,brandId:t.INTEGER,stockCode:t.STRING,isFeatured:t.BOOLEAN,isArchived:t.BOOLEAN,categoryId:t.INTEGER,storeId:t.INTEGER},{sequelize:e,modelName:"Product"}),n}},5611:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Product,{foreignKey:"productId",as:"prodCombinations"}),this.hasOne(e.ProductImage,{foreignKey:"productCombinationId",as:"variantImage"}),this.belongsToMany(e.ProductVariationOption,{through:{model:"ProductVariants"},as:"productVariants",foreignKey:"productCombinationId",otherKey:"productVariationOptionId"})}}]),t}(d);return n.init({price:t.FLOAT,productId:t.INTEGER,sku:t.STRING,availableStock:t.STRING,combinationString:t.TEXT},{sequelize:e,modelName:"ProductCombination"}),n}},3769:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.ProductCombination,{foreignKey:"productCombinationId",as:"variantImage"})}}]),t}(d);return n.init({link:t.STRING,productCombinationId:t.INTEGER,storeId:t.INTEGER},{sequelize:e,modelName:"ProductImage"}),n}},9597:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){}}]),t}(d);return n.init({productCombinationId:t.INTEGER,productVariationOptionId:t.INTEGER},{sequelize:e,modelName:"ProductVariant"}),n}},3285:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Product,{foreignKey:"productId",as:"prodVariations"}),this.hasMany(e.ProductVariationOption,{foreignKey:"productVariationId",as:"prodVarOptions"})}}]),t}(d);return n.init({name:t.STRING,productId:t.INTEGER},{sequelize:e,modelName:"ProductVariation"}),n}},8084:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.ProductVariation,{foreignKey:"productVariationId",as:"prodVarOptions"}),this.belongsToMany(e.ProductCombination,{through:{model:"ProductVariants"},as:"productVariants",foreignKey:"productCombinationId",otherKey:"productVariationOptionId"})}}]),t}(d);return n.init({value:t.STRING,productVariationId:t.INTEGER},{sequelize:e,modelName:"ProductVariationOption"}),n}},7760:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsToMany(e.Product,{through:{model:"PromotionProducts"},as:"promotionProducts",foreignKey:"promotionId",otherKey:"productId"}),this.belongsToMany(e.Customer,{through:{model:"PromotionCustomers"},as:"customerPromotions",foreignKey:"customerId",otherKey:"promotionId"}),this.hasMany(e.Sale,{foreignKey:"promotionId",as:"salePromotions"}),this.hasOne(e.Coupon,{foreignKey:"promotionId",as:"coupon"}),this.belongsTo(e.Store,{foreignKey:"storeId",as:"storePromotions"})}}]),t}(d);return n.init({name:t.ENUM(["coupon","free_gifts","discount","free_shipping","upsell_special","member_referral","free_trial","give_away","bogo","loyalty","bundle","tiered_discount","subscription","flash_sale","competition","donation","cash_back"]),startDate:t.DATE,endDate:t.DATE,description:t.STRING,discountType:t.ENUM(["fixed","percent"]),active:t.BOOLEAN,discountValue:t.DECIMAL,storeId:t.INTEGER},{sequelize:e,modelName:"Promotion"}),n}},2804:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.PromotionCustomer,{foreignKey:"storeId",as:"promotionCustomers"})}}]),t}(d);return n.init({customerId:t.INTEGER,storeId:t.INTEGER,productId:t.INTEGER,redemptionDate:t.DATE,reedemed:t.BOOLEAN},{sequelize:e,modelName:"PromotionCustomer"}),n}},9901:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Store,{foreignKey:"storeId",as:"promotionProducts"})}}]),t}(d);return n.init({promotionId:t.INTEGER,productId:t.INTEGER,storeId:t.INTEGER},{sequelize:e,modelName:"PromotionProduct"}),n}},642:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Customer,{foreignKey:"customerId",as:"customerPurchases"})}}]),t}(d);return n.init({customerId:t.INTEGER,purchaseDate:t.DATE,totalAmount:t.DECIMAL,pointsEarned:t.INTEGER},{sequelize:e,modelName:"Purchase"}),n}},2336:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Reward,{foreignKey:"rewardId",as:"rewardRedemptions"}),this.belongsTo(e.Customer,{foreignKey:"customerId",as:"customerRedemptions"})}}]),t}(d);return n.init({customerId:t.INTEGER,rewardId:t.INTEGER,redemptionDate:t.DATE,pointsUsed:t.INTEGER},{sequelize:e,modelName:"Redemption"}),n}},294:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.hasMany(e.Redemption,{foreignKey:"rewardId",as:"rewardRedemptions"})}}]),t}(d);return n.init({rewardName:t.STRING,pointsRequired:t.INTEGER,description:t.TEXT},{sequelize:e,modelName:"Reward"}),n}},9248:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){}}]),t}(d);return n.init({route:t.INTEGER,capacity:t.INTEGER},{sequelize:e,modelName:"Route"}),n}},3514:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Customer,{foreignKey:"customerId",as:"customerSales"}),this.belongsTo(e.Promotion,{foreignKey:"promotionId",as:"salePromotions"}),this.hasMany(e.SaleDetail,{foreignKey:"salesId",as:"saleDetails"}),this.belongsTo(e.Store,{foreignKey:"storeId",as:"storeSales"})}}]),t}(d);return n.init({customerId:t.INTEGER,saleDate:t.DATE,invoiceNo:t.STRING,storeId:t.INTEGER,promotionId:t.INTEGER,totalAmount:t.DECIMAL},{sequelize:e,modelName:"Sale"}),n}},7183:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Product,{foreignKey:"productId",as:"productSales"}),this.belongsTo(e.Sale,{foreignKey:"salesId",as:"saleDetails"})}}]),t}(d);return n.init({salesId:t.INTEGER,productId:t.INTEGER,unitPrice:t.DECIMAL,discount:t.DECIMAL,quantity:t.INTEGER},{sequelize:e,modelName:"SaleDetail"}),n}},2297:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.hasOne(e.BulkTemplateTask,{foreignKey:"scheduleTaskId",as:"bulkTempTask"}),this.belongsTo(e.Merchant,{foreignKey:"merchantId",as:"merchantsTasks"})}}]),t}(d);return n.init({merchantId:t.INTEGER,type:t.STRING,timestamp:t.DATE,status:t.ENUM(["EXECUTED","PENDING","FAILED"])},{sequelize:e,modelName:"ScheduleTask"}),n}},4921:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Merchant,{foreignKey:"merchantId"})}}]),t}(d);return n.init({callBack_url:t.STRING,app_id:t.STRING,app_secret:t.STRING,phone_number_id:t.STRING,business_account_id:t.STRING,access_token:t.STRING,api_version:t.STRING,webhook_verification_token:t.STRING,phone_number:t.STRING,merchantId:t.INTEGER},{sequelize:e,modelName:"Setting"}),n}},9512:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Merchant,{foreignKey:"merchantId"}),this.hasMany(e.Billboard,{foreignKey:"storeId"}),this.hasMany(e.Category,{foreignKey:"storeId"}),this.hasMany(e.Product,{foreignKey:"storeId"}),this.hasMany(e.Order,{foreignKey:"storeId",as:"storeOrder"}),this.hasMany(e.Promotion,{foreignKey:"storeId",as:"storePromotions"}),this.hasMany(e.PromotionProduct,{foreignKey:"storeId",as:"promotionProducts"}),this.hasMany(e.PromotionCustomer,{foreignKey:"storeId",as:"promotionCustomers"}),this.hasMany(e.Sale,{foreignKey:"storeId",as:"storeSales"}),this.hasMany(e.Brand,{foreignKey:"storeId"}),this.hasOne(e.MpesaSetting,{foreignKey:"storeId",as:"mpesa"})}}]),t}(d);return n.init({name:t.STRING,merchantId:t.INTEGER},{sequelize:e,modelName:"Store"}),n}},1896:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveTemplate,{foreignKey:"interactiveTemplateId",as:"tempReply"}),this.belongsTo(e.Message,{foreignKey:"messageId",as:"mesTempReply"})}}]),t}(d);return n.init({messageId:t.INTEGER,text:t.STRING,payload:t.STRING,interactiveTemplateId:t.INTEGER},{sequelize:e,modelName:"TemplateRepliedAction"}),n}},1757:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveTemplate,{foreignKey:"interactiveTemplateId",as:"buttons"})}}]),t}(d);return n.init({interactiveTemplateId:t.INTEGER,text:t.STRING,type:t.STRING},{sequelize:e,modelName:"TemplateReplyAction"}),n}},7587:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.InteractiveButton,{foreignKey:"interactiveButtonId",as:"btnTextHead"}),this.belongsTo(e.InteractiveList,{foreignKey:"interactiveListId",as:"listTextHead"}),this.belongsTo(e.InteractiveTemplate,{foreignKey:"interactiveTemplateId",as:"tempTextHead"})}}]),t}(d);return n.init({interactiveButtonId:t.INTEGER,interactiveListId:t.INTEGER,interactiveTemplateId:t.INTEGER,body:t.TEXT},{sequelize:e,modelName:"TextHeader"}),n}},5487:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Message,{foreignKey:"messageId",as:"text"})}}]),t}(d);return n.init({body:t.TEXT,messageId:t.INTEGER},{sequelize:e,modelName:"TextMessage"}),n}},5167:(e,t,n)=>{"use strict";var r=n(5998),a=n(8898),o=n(6609),s=n(9285),i=n(2750);function c(e,t,n){return t=s(t),o(e,u()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var d=n(9031).Model;e.exports=function(e,t){var n=function(e){function t(){return r(this,t),c(this,t,arguments)}return i(t,e),a(t,null,[{key:"associate",value:function(e){this.belongsTo(e.Message,{foreignKey:"messageId",as:"video"})}}]),t}(d);return n.init({caption:t.TEXT,mimeType:t.STRING,sha256:t.STRING,videoId:t.STRING,url:t.STRING,messageId:t.INTEGER},{sequelize:e,modelName:"VideoMessage"}),n}},7906:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(7252).Router();n(818).config();var s=n(3268),i=n(4104),c=n(6919).createMessageTemplate,u=n(6919).listTemplates;o.use(s.json()),o.post("/",function(){var e=a(r.mark((function e(t,n,a){var o,s,d,p,l;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u();case 3:o=e.sent,console.log("##############I AM HERE IN CREATING TEMPLATES3<<<<<<<<<<<<<<#############",o),o.data.data.map((function(e){return console.log(e)})),s=o.data.data.filter((function(e){return"APPROVED"===e.status})),console.log("$%$%$%$%",s),d=i.messageTemplates,console.log("LOCLA TEMPLATES",d),console.log("#3333333#############################33",d.length),p=r.mark((function e(){var t,n;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=d[l],console.log("In here*(*(*(*(*(*"),n=s.filter((function(e){return e.name==process.env.TEMPLATE_NAME_PREFIX+"_"+t.name})),console.log("Creating template: ".concat(t.name,".")),!(n.length>0)){e.next=7;break}return console.log("Template ".concat(n[0].name," already exists.")),e.abrupt("return",1);case 7:return e.prev=7,e.next=10,c(t);case 10:console.log("Template ".concat(t.name," created successfully.")),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(7),console.log("Failed creating template ".concat(t.name,".")),console.log("###########",e.t0.response.data);case 17:case"end":return e.stop()}}),e,null,[[7,13]])})),l=0;case 13:if(!(l<d.length)){e.next=20;break}return e.delegateYield(p(),"t0",15);case 15:if(!e.t0){e.next=17;break}return e.abrupt("continue",17);case 17:l++,e.next=13;break;case 20:e.next=26;break;case 22:e.prev=22,e.t1=e.catch(0),console.log("Failed obtaining remote template list."),console.log("##########",e.t1);case 26:console.log("Redirecting to the backoffice.");case 27:case"end":return e.stop()}}),e,null,[[0,22]])})));return function(t,n,r){return e.apply(this,arguments)}}()),e.exports=o},8411:(e,t,n)=>{var r,a=n(7738),o=n(5564),s=n(4979),i=n(8059),c=(0,n(2369).gql)(r||(r=s(["\n  query setting($username: String!){\n    setting(username: $username){\n        app_id\n        app_secret\n        phone_number_id\n        business_account_id\n        access_token\n        api_version\n        webhook_verification_token\n        phone_number\n    }\n  }\n"])));function u(e){return d.apply(this,arguments)}function d(){return(d=o(a.mark((function e(t){var n,r,o,s;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=18;break}return e.prev=1,n={username:t},e.next=5,i.request(c,n);case 5:return r=e.sent,o=r.setting,s=o,console.log("SETTINGS FOR ".concat(t),s),e.abrupt("return",s);case 12:e.prev=12,e.t0=e.catch(1),console.log("Failed to retrieve user settings>>>>>>>>>>"),console.log(e.t0);case 16:e.next=19;break;case 18:throw new Error("Failed to suppply the username");case 19:case"end":return e.stop()}}),e,null,[[1,12]])})))).apply(this,arguments)}function p(){return(p=o(a.mark((function e(t){var n,r,o;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=t.query.username)){e.next=17;break}return e.prev=2,e.next=5,u(n).then((function(e){return e}));case 5:if(r=e.sent,console.log("WEBHOOK VERIFICATION>>>>>".bgGreen,r.webhook_verification_token),!(o=r.webhook_verification_token)){e.next=10;break}return e.abrupt("return",o);case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),console.log("Error getting the verification token",e.t0);case 15:e.next=19;break;case 17:throw console.log("Could not find a username in the callback url"),new Error;case 19:case"end":return e.stop()}}),e,null,[[2,12]])})))).apply(this,arguments)}function l(){return(l=o(a.mark((function e(t){var n,r,o;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=t.query.username)){e.next=19;break}return e.prev=2,e.next=5,u(n).then((function(e){return e}));case 5:if(r=e.sent,console.log("THE SETTINGS",r),o=r.app_secret,console.log("app secret>>>>>",o),!o){e.next=11;break}return e.abrupt("return",o);case 11:e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(2),console.log("Error getting the app secret"),new Error(e.t0);case 17:e.next=21;break;case 19:throw console.log("Could not find a username in the callback url"),new Error;case 21:case"end":return e.stop()}}),e,null,[[2,13]])})))).apply(this,arguments)}t&&(t.getSettings=u,t.getVerificationToken=function(e){return p.apply(this,arguments)},t.getAppSecret=function(e){return l.apply(this,arguments)})},8488:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(7252).Router(),s=(n(9173).messageStatuses,n(9113)),i=n(8430),c=(n(6919).sendWhatsAppMessage,n(8411)),u=c.getVerificationToken,d=c.getSettings,p=n(1255).getPayload;o.post("/",function(){var e=a(r.mark((function e(t,n,a){var o,c,u,l,m,h;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.query.username,e.next=3,d(o).then((function(e){return e}));case 3:if(c=e.sent,u=c.app_secret,l=new s("SHA256",u),m=l.sign(t.rawBody).toLowerCase(),console.log("AOO SECRE>>>>>",u,l,m,t.headers["x-hub-signature-256"]),t.headers["x-hub-signature-256"]==m){e.next=12;break}return console.log("Warning - request header X-Hub-Signature not present or invalid"),n.sendStatus(401),e.abrupt("return");case 12:if(console.log("request header X-Hub-Signature validated"),h=t.body.entry[0].changes[0],p(t),"messages"===h.field){e.next=17;break}return e.abrupt("return",n.sendStatus(400));case 17:h.value.hasOwnProperty("messages")&&h.value.messages.forEach((function(e){return i(e,c)})),n.sendStatus(200);case 19:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()),o.get("/",function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u(t).then((function(e){return e}));case 2:o=e.sent,console.log("VERIFICATION TOKEN",o),console.log("queries in Get",t.query),"subscribe"==t.query["hub.mode"]&&t.query["hub.verify_token"]==o?n.send(t.query["hub.challenge"]):n.sendStatus(400);case 6:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()),e.exports=o},2700:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(8938),s=n(618).logger,i=n(4716),c=function(){var e=a(r.mark((function e(t){var n,a,i,c,u,d;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.consumer_key,a=void 0===n?null:n,i=t.consumer_secret,c=void 0===i?null:i,a||c){e.next=4;break}return s.log({level:"error",message:"Consumer key and consumer key not passed"}),e.abrupt("return");case 4:return u="Basic "+btoa("".concat(a,":").concat(c)),e.prev=5,e.next=8,o.get(process.env.mpesa_cridential,{headers:{Authorization:u}}).then((function(e){return console.log("Data:",e.data),e.data.access_token})).catch((function(e){console.error("Error:",e.message)}));case 8:return d=e.sent,e.abrupt("return",d);case 12:e.prev=12,e.t0=e.catch(5),console.log("[ERROR GETTING AUTHENTICATION TOKEN]",e.t0.message),s.log({level:"error",message:e.t0.message});case 16:case"end":return e.stop()}}),e,null,[[5,12]])})));return function(t){return e.apply(this,arguments)}}();process.env.business_shortcode,process.env.pass_key,process.env.consumer_key,process.env.consumer_secret,t&&(t.generate_access_token=c,t.generate_password=function(e){var t=e.business_shortcode,n=void 0===t?null:t,r=e.pass_key,a=void 0===r?null:r,o=(new Date,i().format("YYYYMMDDHHmmss")),s=n.toString()+a+o;return{password:new Buffer.from(s,"utf-8").toString("base64"),timestamp:o}})},919:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(7252).Router(),s=(n(9173).messageStatuses,n(9113),n(2700));s.generate_access_token,s.generate_password,o.post("/",function(){var e=a(r.mark((function e(t,n,a){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("A POST REQUEST FROM MPESA".green,t.get("host"));case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()),o.get("/",function(){var e=a(r.mark((function e(t,n,a){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("A GET REQUEST FROM MPESA".green,t.get("host"));case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()),e.exports=o},2511:(e,t,n)=>{var r=n(1116),a=n(6921),o=a.mapSchema,s=a.getDirective,i=a.MapperKind;t&&(t.authDirective=function(e){var t={};return{authDirectiveTypeDefs:"directive\n            @".concat(e," on QUERY | FIELD_DEFINITION | FIELD\n        "),authDirectiveTransformer:function(n){return o(n,r(r({},i.TYPE,(function(r){var a,o=null===(a=s(n,r,e))||void 0===a?void 0:a[0];o&&(t[r.name]=o)})),i.OBJECT_FIELD,(function(r,a,o){var i,c;if(null!==(i=null===(c=s(n,r,e))||void 0===c?void 0:c[0])&&void 0!==i?i:t[o]){var u=r.resolve;return r.defaultFieldResolver,r.resolve=function(e,t,n,r){if(n.merchant)return u(e,t,n,r);throw new Error("Unauthenticated. You need to be logged in!")},r}})))}}})},2078:(e,t,n)=>{var r=n(7738),a=n(1116),o=n(5564);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var c=n(618).logger,u=n(9577),d=u.getCustomer,p=u.getCusByNumber,l=u.getChat,m=n(3481),h=m.createCustomer,f=m.createChat,g=n(9580).sendTemplateMessage,I=function(){var e=o(r.mark((function e(t){var n,a,o,s,u,m,I,v,y,b,w,x,E,T,k,S,R,M,N,O,C,A,D,P,_,B,G,q,L,U,$,K,j;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.Merchant,a=t.Customer,o=t.Chat,s=t.Message,u=t.InteractiveMessage,m=void 0===u?void 0:u,I=t.InteractiveButton,v=void 0===I?void 0:I,y=t.InteractiveList,b=void 0===y?void 0:y,w=t.InteractiveTemplate,x=void 0===w?void 0:w,E=t.ListSection,T=void 0===E?void 0:E,k=t.participants,S=void 0===k?void 0:k,R=t.message,M=t.context,N=t.customerId,O=void 0===N?void 0:N,C=t.template,A=void 0===C?void 0:C,D=t.contextMessage,P=void 0===D?void 0:D,_=null,B=void 0,G=void 0,q=void 0,L=!1,U=null,$=null,!S){e.next=41;break}return K=S.mer_username,j=S.customer.phone_number,e.next=13,n.findOne({where:{username:K}});case 13:if(G=e.sent){e.next=16;break}throw new Error("Could not get merchant from received webhook",K);case 16:return e.next=18,p(a,j,G.id);case 18:if(B=e.sent){e.next=23;break}return e.next=22,h(a,i(i({},S.customer),{},{status:"new"}),G.id,"new");case 22:B=e.sent;case 23:return e.next=25,l(o,B.id,G.id);case 25:if(q=e.sent,console.log("CUSTOMER and merchant".bgBlue,B.id,G.id),q){e.next=38;break}return e.prev=28,e.next=31,f(o,B.id,G.id);case 31:q=e.sent,L=!0,e.next=38;break;case 35:e.prev=35,e.t0=e.catch(28),c.log({level:"error",message:"[ERROR CREATING CHAT] from webhook for, ".concat(G.id)});case 38:console.log("THE CHAT",q),e.next=80;break;case 41:if(e.prev=41,_=R.message.chatId,G=M.merchant,_&&!(_<0)){e.next=61;break}return e.next=47,d(a,O,G.id);case 47:if(B=e.sent){e.next=50;break}throw new Error("Customer not found make sure the customer is in your customer list.");case 50:if(!B){e.next=59;break}return e.next=53,l(o,B.id,G.id);case 53:if(q=e.sent){e.next=59;break}return e.next=57,f(o,B.id,G.id);case 57:q=e.sent,L=!0;case 59:e.next=70;break;case 61:return e.next=63,o.findOne({where:{id:_},include:[{model:a},{model:n}]});case 63:return q=e.sent,e.next=66,q.getCustomer();case 66:return B=e.sent,e.next=69,q.getMerchant();case 69:G=e.sent;case 70:e.next=75;break;case 72:e.prev=72,e.t1=e.catch(41),c.log({level:"error",message:"ERROR CREATING OR GETTING CHAT FOR MERCHANT, ".concat((new Date).toDateString())});case 75:if(!A){e.next=80;break}return console.log(A),e.next=79,g(A,B,G);case 79:U=e.sent;case 80:if(!P){e.next=103;break}if(!v){e.next=88;break}return console.log("inCluding button"),e.next=85,s.findOne({where:{messageId:P.messageId,chatId:q.id},include:[{model:m,as:"interactive",required:!0,include:[{model:v,as:"button",required:!0,include:["buttons"]}]}]});case 85:$=e.sent,e.next=103;break;case 88:if(!b){e.next=94;break}return e.next=91,s.findOne({where:{messageId:P.messageId,chatId:q.id},include:[{model:m,as:"interactive",required:!0,include:[{model:b,as:"list",include:[{model:T,as:"sections",include:["rows"]}]}]}]});case 91:$=e.sent,e.next=103;break;case 94:if(!x){e.next=100;break}return e.next=97,s.findOne({where:{messageId:P.messageId,chatId:q.id},include:[{model:m,as:"interactive",required:!0,include:[{model:x,as:"template",required:!0}]}]});case 97:$=e.sent,e.next=103;break;case 100:return e.next=102,s.findOne({where:{messageId:P.messageId,chatId:q.id}});case 102:$=e.sent;case 103:return e.abrupt("return",{customer:B,merchant:G,chat:q,addNewChat:L,messageId:U,contextedMessage:$});case 104:case"end":return e.stop()}}),e,null,[[28,35],[41,72]])})));return function(t){return e.apply(this,arguments)}}();e.exports={getCreateChatForMessage:I}},3481:(e,t,n)=>{var r=n(7738),a=n(1116),o=n(5564);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var c=function(){var e=o(r.mark((function e(t,n,a){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.create(i({},n)).then((function(e){return e.setMerchant(a),e}));case 2:return n=e.sent,e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),u=function(){var e=o(r.mark((function e(t,n,a){var s;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.create({conversations:[{category:"marketing",expiryDate:null,status:"closed",conversationId:null,pricingModel:null},{category:"authentication",expiryDate:null,status:"closed",conversationId:null,pricingModel:null},{category:"utility",expiryDate:null,status:"closed",conversationId:null,pricingModel:null},{category:"service",expiryDate:null,status:"closed",conversationId:null,pricingModel:null}]},{include:{association:"conversations"}}).then(function(){var e=o(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([t.setMerchant(a),t.setCustomer(n)]);case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 2:return s=e.sent,e.abrupt("return",s);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}();e.exports={createCustomer:c,createChat:u}},9577:(e,t,n)=>{var r=n(7738),a=n(5564),o=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),s=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{name:n,merchantId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),i=function(){var e=a(r.mark((function e(t,n){var a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n)}});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),c=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{label:n,storeId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),u=function(){var e=a(r.mark((function e(t,n){var a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n)}});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),d=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{name:n,categoryId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),p=function(){var e=a(r.mark((function e(t,n){var a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n)}});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),l=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{name:n,billboardId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),m=function(){var e=a(r.mark((function e(t,n){var a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n)}});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),h=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{name:n,storeId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),f=function(){var e=a(r.mark((function e(t,n){var a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n)}});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),g=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{name:n,storeId:a}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),I=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:parseInt(n),merchantId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),v=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{phone_number:n,merchantId:parseInt(a)}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),y=function(){var e=a(r.mark((function e(t,n,a){var o,s,i=arguments;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=null,void 0===(o=i.length>3&&void 0!==i[3]?i[3]:void 0)){e.next=8;break}return e.next=5,t.findOne({where:{merchantId:parseInt(a),id:parseInt(o)}});case 5:s=e.sent,e.next=12;break;case 8:if(!n||!a){e.next=12;break}return e.next=11,t.findOne({where:{merchantId:parseInt(a),customerId:parseInt(n)}});case 11:s=e.sent;case 12:return e.abrupt("return",s);case 13:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),b=function(){var e=a(r.mark((function e(t,n,a){var o,s,i=arguments;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=null,void 0===(o=i.length>3&&void 0!==i[3]?i[3]:void 0)){e.next=8;break}return e.next=5,t.findOne({where:{merchantId:parseInt(a),id:parseInt(o)}});case 5:s=e.sent,e.next=12;break;case 8:if(!n||!a){e.next=12;break}return e.next=11,t.findOne({where:{merchantId:parseInt(a),customerId:parseInt(n)}});case 11:s=e.sent;case 12:return e.abrupt("return",s);case 13:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),w=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{merchantId:n,name:a}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),x=function(){var e=a(r.mark((function e(t,n,a){var o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.findOne({where:{id:a,merchantId:n}});case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}();e.exports={getStore:o,getDupStore:s,getBillboard:i,getDupBillboard:c,getCategory:p,getDupCategory:l,getSize:f,getDupSize:g,getProduct:u,getDupProduct:d,getCustomer:I,getCusByNumber:v,getChat:y,getMessage:b,getAdTemplate:w,getAd:x,getBrand:m,getDupBrand:h}},3338:(e,t,n)=>{var r=n(1253),a=r.GraphQLScalarType,o=r.Kind,s=new a({name:"Date",description:"Date custom scalar type",serialize:function(e){if(e instanceof Date)return e.getTime();throw Error("GraphQL Date Scalar serializer expected a `Date` object")},parseValue:function(e){if("number"==typeof e)return new Date(e);throw new Error("GraphQL Date Scalar parser expected a `number`")},parseLiteral:function(e){return e.kind===o.INT?new Date(parseInt(e.value,10)):null}}),i=new a({name:"Decimal",description:"The `Decimal` scalar type to represent currency values",serialize:function(e){return new Big(e)},parseLiteral:function(e){if(e.kind!==o.STRING)throw new TypeError("".concat(String(e.value)," is not a valid decimal value."));return Big(e.value)},parseValue:function(e){return Big(e)}});t&&(t.Date=s,t.Decimal=i)},9580:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(618).logger,s=n(6919).sendWhatsAppMessage,i=function(){var e=a(r.mark((function e(t,n,a){var i,c,u,d,p;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i=JSON.parse(t),c=n.dataValues.phone_number,i.to=c,e.next=6,a.getSetting();case 6:return u=(u=e.sent).dataValues,console.log("TEMPLATE DATA>>>>>>>>>",i),e.next=11,s(i,u);case 11:return d=e.sent,p=d.data,console.log("After sending the template message".bgCyan,p),messageId=p.messages[0].id,e.abrupt("return",messageId);case 18:e.prev=18,e.t0=e.catch(0),console.log(e.t0.message),o.log({level:"error",message:"[ERROR SENDING MESSAGE TO CUSTOMER] for ".concat(a.id)});case 22:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(t,n,r){return e.apply(this,arguments)}}();e.exports={sendTemplateMessage:i}},4284:(e,t)=>{t&&(t.setCookie=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=new Date;r.setDate(r.getDate()+1),e.cookies.set("authorization",t,{signed:!0,expires:n?new Date:r,httpOnly:!0,secure:!1,sameSite:"strict"})})},6495:(e,t,n)=>{var r=n(7738),a=n(1116),o=n(5564);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var c=n(9577).getAd,u=function(){var e=o(r.mark((function e(t){var n,a,o,s,u,p;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.Ad,a=t.merchantId,o=t.adId,s=t.MarketingResponse,u=t.response,e.next=3,c(n,a,o);case 3:if(p=e.sent,console.log("updating marketing id".bgBlue,p),!p){e.next=10;break}return e.next=8,n.update(i(i({},p),{},{response:null!==p.response?p.response+=1:1}),{where:{id:p.id},silent:!1});case 8:e.sent,d({MarketingResponse:s,response:i(i({},u),{},{adTemplateId:p.templateId})});case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),d=function(){var e=o(r.mark((function e(t){var n,a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.MarketingResponse,a=t.response,e.next=3,n.create(i({},a));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();e.exports={tempMarketPerformance:u}},6617:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(6299).ApolloServer,s=n(5963).makeExecutableSchema,i=n(3133).ApolloServerPluginDrainHttpServer,c=n(7252),u=n(8611);n(818).config;var d=n(7898),p=n(6854),l=n(2511).authDirective,m=c(),h=u.createServer(m);e.exports={server:function(e){var t=l("auth"),n=t.authDirectiveTypeDefs,c=t.authDirectiveTransformer,u=s({typeDefs:[n,p],resolvers:d.call(e)});return u=c(u),new o({schema:u,plugins:[i({httpServer:h}),{serverWillStart:function(){return a(r.mark((function e(){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{drainServer:function(){return a(r.mark((function e(){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,subscriptionServer.dispose();case 2:case"end":return e.stop()}}),e)})))()}});case 1:case"end":return e.stop()}}),e)})))()}}]})}}},7898:(e,t,n)=>{var r=n(2462),a=n(4433),o=n(1116),i=n(7738),c=n(5564),u=["id"];function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var l=n(618).logger;n(3672),n(818).config();var m=n(6919).sendWhatsAppMessage,h=n(5486),f=n(829),g=n(9031),I=g.Op,v=(g.where,n(4284).setCookie),y=n(3946),b=y.withFilter,w=y.PubSub,x=n(9577),E=x.getStore,T=x.getBillboard,k=x.getCategory,S=x.getProduct,R=x.getDupProduct,M=x.getDupStore,N=x.getDupBillboard,O=x.getDupCategory,C=x.getCustomer,A=x.getCusByNumber,D=x.getChat,P=x.getAd,_=n(3481),B=_.createCustomer,G=_.createChat,q=n(9173).messageStatuses,L=n(2078).getCreateChatForMessage,U=n(6495).tempMarketPerformance,$=(n(5124).level,new w),K=process.env.JWT_SECRET;e.exports=function(){var e=this.db.db.models,t=e.Customer,n=e.Merchant,d=e.Chat,g=e.Conversation,y=e.Message,w=e.Setting,x=e.Product,_=e.Image,j=e.Store,z=e.Billboard,H=e.Category,V=e.Brand,F=e.TextMessage,Y=e.ImageMessage,W=e.DocumentMessage,X=e.VideoMessage,Q=e.InteractiveMessage,J=e.InteractiveButton,Z=e.InteractiveTemplate,ee=e.InteractiveList,te=e.ListRowButton,ne=e.ListSection,re=e.ButtonRepliedAction,ae=e.ListRepliedAction,oe=e.TemplateRepliedAction,se=e.Order,ie=e.TextHeader,ce=e.Ad,ue=e.AdTemplate,de=e.MarketingResponse,pe=e.ScheduleTask,le=e.Promotion,me=e.Coupon,he=e.Sale,fe=e.MpesaSetting,ge={Customer:{merchant:function(e,t,n){return e.getMerchant()}},Chat:{messages:function(e,t,n){return e.getMessages({order:[["createdAt","ASC"]]})},merchant:function(e,t,n){return e.getMerchant()},customer:function(e,t,n){return e.getCustomer()}},Message:{chat:function(e,t,n){return e.getChat()}},Ad:{adTemplate:function(e,t,n){return e.getAdTemplate()}},Merchant:{customers:function(e,t,n){return e.getCustomers()},setting:function(e,t,n){return e.getSetting()},products:function(e,t,n){return e.getProducts()},chats:function(e,t,n){return e.getChats({order:[["createdAt","ASC"]]})},stores:function(e,t,n){return e.getStore()}},Store:{merchant:function(e,t,n){return e.getMerchant()},billboards:function(e,t,n){return e.getBillboards()},products:function(e,t,n){return e.getProducts()}},Billboard:{store:function(e,t,n){return e.getStore()},categories:function(e,t,n){return e.getCategories()}},Category:{billboard:function(e,t,n){return e.getBillboard()},store:function(e,t,n){return e.getStore()},products:function(e,t,n){return e.getProducts()}},Product:{store:function(e,t,n){return e.getStore()},category:function(e,t,n){return e.getCategory()},images:function(e,t,n){return e.getImages()}},RootQuery:{currentMerchant:function(e,t,n){return c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.merchant);case 1:case"end":return e.stop()}}),e)})))()},customers:function(e,t,r){return c(i.mark((function e(){var t;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.findOne({where:{id:r.merchant.id}});case 2:if(t=e.sent){e.next=5;break}throw new Error("It seems you are not registered. Sign up to start managing your customers");case 5:return e.next=7,t.getCustomers();case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})))()},customer:function(e,n,r){return c(i.mark((function e(){var a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.customerId,e.next=3,t.findOne({where:{id:a,merchantId:r.merchant.id}});case 3:if(o=e.sent){e.next=6;break}throw new Error("Unautharized operation could not find the customer");case 6:return e.abrupt("return",o);case 7:case"end":return e.stop()}}),e)})))()},customer360:function(e,n,r){return c(i.mark((function e(){var a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.customerId,o=r.merchant){e.next=4;break}throw new Error("Unauthenticated! Make sure you are logged in.");case 4:return e.next=6,t.findOne({where:{id:a,merchantId:o.id},include:[{association:"customerOrder",include:[{association:"storeOrder"},{association:"orderItems",include:{association:"orderProduct"}}]}]});case 6:if(s=e.sent){e.next=9;break}throw new Error("Unautharized operation could not find the customer");case 9:return e.abrupt("return",s);case 10:case"end":return e.stop()}}),e)})))()},customerChatSearch:function(e,n,r){return c(i.mark((function e(){var a,s,c,u,p,l,m,h;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.page,s=n.limit,c=n.text,u=[],!(c.length<3)){e.next=4;break}return e.abrupt("return",{customers:u});case 4:return p=0,a&&s&&(p=a*s),l={order:[["createdAt","DESC"]],offset:p},s&&(l.limit=s),l.where=o({},I.or,[{first_name:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id},{last_name:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id},{phone_number:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id}]),e.next=11,t.findAll(l);case 11:if(0!==(u=e.sent).length){e.next=14;break}throw new Error('No results found for "'.concat(c,'"'));case 14:return m=u.map((function(e){return e.id})),e.next=17,d.findAll({where:{merchantId:r.merchant.id,customerId:o({},I.in,m)}});case 17:if(!(h=e.sent)){e.next=22;break}return e.next=21,u.filter((function(e){return h.every((function(t){return e.id!==t.customerId}))}));case 21:u=e.sent;case 22:return e.abrupt("return",{customers:u,chats:h});case 23:case"end":return e.stop()}}),e)})))()},customersSearch:function(e,n,r){return c(i.mark((function e(){var a,s,c,u,d,p;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.page,s=n.limit,c=n.text,u=[],!(c.length<3)){e.next=4;break}return e.abrupt("return",{customers:u});case 4:return d=0,a&&s&&(d=a*s),p={order:[["createdAt","DESC"]],offset:d},s&&(p.limit=s),p.where=o({},I.or,[{first_name:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id},{last_name:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id},{phone_number:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id}]),e.next=11,t.findAll(p);case 11:return(u=e.sent).length,e.abrupt("return",u);case 14:case"end":return e.stop()}}),e)})))()},chats:function(e,r,a){return c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.findOne({where:{id:a.merchant.id}});case 2:if(e.sent){e.next=5;break}throw new Error("It seems you are not registered. Sign up to start managing your customers");case 5:return e.abrupt("return",d.findAll({where:{merchantId:a.merchant.id},order:[["updatedAt","DESC"]],include:[{model:t,required:!0}]}));case 6:case"end":return e.stop()}}),e)})))()},lastMessage:function(e,t,n){return c(i.mark((function e(){var r,a;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.chatId,n.merchant){e.next=3;break}throw new Error("Unauthenticated make sure you are logged in.");case 3:if(!r){e.next=8;break}return e.next=6,y.findAll({where:{chatId:r},include:[{model:F,as:"text"},{model:Y,as:"image"},{model:W,as:"document"},{model:X,as:"video"},{model:Q,as:"interactive",include:[{model:J,as:"button",include:["buttons","product"]},{model:Z,as:"template",include:["buttons","tempProduct"]},{model:ee,as:"list",include:[{model:ie,as:"listTextHead"},{model:ne,as:"sections",include:[{model:te,as:"rows",include:["product"]}]}]}]},{model:re,as:"mesBtnReply",required:!1,include:[{model:J,as:"buttonReply",include:["product"]}]},{model:oe,as:"mesTempReply",required:!1,include:[{model:Z,as:"tempReply",include:["tempProduct"]}]},{model:ae,as:"mesListReply",required:!1,include:[{model:te,as:"listReply",include:["product"]}]},{model:d}],order:[["createdAt","DESC"]],limit:1});case 6:return a=e.sent,e.abrupt("return",a[0]);case 8:case"end":return e.stop()}}),e)})))()},chat:function(e,r,a){return c(i.mark((function e(){var o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.chatId,e.next=3,n.findOne({where:{id:a.merchant.id}});case 3:if(e.sent){e.next=6;break}throw new Error("Unauthenticated make sure you are logged in");case 6:return e.next=8,d.findOne({where:{id:o,merchantId:a.merchant.id},include:[{model:y,as:"messages",include:[{model:ce,as:"messageAd"},{model:y,as:"contexts",include:["text","image","document","video","interactive"]},{model:y,as:"context",include:[{model:F,as:"text",required:!1},{model:Y,as:"image",required:!1},{model:W,as:"document",required:!1},{model:X,as:"video",required:!1},{model:Q,as:"interactive",include:[{model:J,as:"button",include:["product"]},{model:Z,as:"template",include:["tempProduct"]},{model:ee,as:"list",include:[{model:ie,as:"listTextHead"}]}]}]},{model:F,as:"text",required:!1},{model:Y,as:"image",required:!1},{model:W,as:"document",required:!1},{model:X,as:"video",required:!1},{model:re,as:"mesBtnReply",required:!1,include:[{model:J,as:"buttonReply",include:["product"]}]},{model:oe,as:"mesTempReply",required:!1,include:[{model:Z,as:"tempReply",include:["tempProduct"]}]},{model:ae,as:"mesListReply",required:!1,include:[{model:te,as:"listReply",include:["product"]}]},{model:Q,as:"interactive",required:!1,include:[{model:J,as:"button",include:["btnImageHead","btnTextHead","buttons","product"]},{model:Z,as:"template",include:["tempImageHead","tempTextHead","buttons","tempProduct"]},{model:ee,as:"list",include:[{model:ie,as:"listTextHead"},{model:ne,as:"sections",include:[{model:te,as:"rows",include:["product"]}]}]}]}]},{model:t},{model:g,as:"conversations"}],order:[[{model:y,as:"messages"},"createdAt","ASC"]]});case 8:if(s=e.sent){e.next=11;break}throw new Error("Unauthorized operation");case 11:return e.abrupt("return",s);case 12:case"end":return e.stop()}}),e)})))()},ads:function(e,t,n){return c(i.mark((function e(){var r,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a(t),r=n.merchant){e.next=4;break}throw new Error("Unauthenticated please make sure you are logged in.");case 4:return e.next=6,ce.findAll({where:{merchantId:r.id},include:{model:ue},order:[["createdAt","DESC"]]});case 6:return o=e.sent,e.abrupt("return",o);case 8:case"end":return e.stop()}}),e)})))()},tempMarketResponse:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.adTemplateId,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated please make sure you are logged in.");case 4:return e.next=6,ue.findOne({where:{merchantId:a.id,id:r},include:[{association:"adTempProduct"},{association:"adTempMessage",include:{association:"interactive",include:{association:"template",include:["buttons"]}}},{association:"adTempResponses",include:[{association:"cusTempLead"},{association:"mesTempLead",include:["mesTempReply"]}]}]});case 6:if(o=e.sent){e.next=9;break}throw new Error("We could not find your ad Template");case 9:return e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})))()},setting:function(e,t,r){return c(i.mark((function e(){var a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.username,o=null,!a||r.merchant){e.next=11;break}return e.next=5,n.findOne({where:{username:a}});case 5:if(o=e.sent){e.next=9;break}return l.log({level:"error",message:'error retriving settings for merchant requested by webhook, "'.concat(a,'" could not find the username')}),e.abrupt("return");case 9:e.next=12;break;case 11:o=r.merchant;case 12:if(o){e.next=14;break}throw new Error("Failed to authenticate you while retrieving settings Contact us to solve this");case 14:return e.next=16,o.getSetting();case 16:if(!(s=e.sent)){e.next=21;break}return e.abrupt("return",s);case 21:return e.abrupt("return");case 22:case"end":return e.stop()}}),e)})))()},stores:function(e,t,n){return c(i.mark((function e(){var t,r,a;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=void 0,e.next=3,n.merchant;case 3:if(r=e.sent){e.next=6;break}throw new Error("Make sure you are logged in to access your products");case 6:return(a={order:[["createdAt","DESC"]]}).where={"$Store.merchantId$":r.id},e.next=10,j.findAll(a);case 10:if(t=e.sent){e.next=13;break}throw new Error("Add stores to view them here");case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e)})))()},store:function(e,t,n){return c(i.mark((function e(){var r,a;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,n.merchant){e.next=3;break}throw new Error("Unauthenticated make sure you are logged in");case 3:if(!r){e.next=10;break}return e.next=6,E(j,r,n.merchant.id);case 6:if(a=e.sent){e.next=9;break}throw new Error("Could not find the store");case 9:return e.abrupt("return",a);case 10:case"end":return e.stop()}}),e)})))()},mpesa:function(e,t,n){return c(i.mark((function e(){var n;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.storeId){e.next=3;break}throw new Error("Store id is required.");case 3:return e.prev=3,e.next=6,fe.findOne({where:{storeId:n}});case 6:return e.abrupt("return",e.sent);case 9:throw e.prev=9,e.t0=e.catch(3),l.log({level:"error",message:"Could not retrieve mpesa settings for store ".concat(n)}),new Error("Something went wrong");case 13:case"end":return e.stop()}}),e,null,[[3,9]])})))()},billboards:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in");case 4:if(r){e.next=6;break}throw new Error("We couldn't find a store ID");case 6:return e.prev=6,e.next=9,E(j,r,a.id);case 9:if(e.sent){e.next=12;break}throw new Error("Unauthorized operation");case 12:if(o=z.findAll({where:{storeId:r}})){e.next=15;break}throw new Error("This store has no billboards yet");case 15:return e.abrupt("return",o);case 18:throw e.prev=18,e.t0=e.catch(6),l.log({level:"error",message:"An error occurred for ".concat(a.id," while querying for billboards")}),new Error("Something went wrong while getting your billboards",e.t0);case 22:case"end":return e.stop()}}),e,null,[[6,18]])})))()},billboard:function(e,t,n){return c(i.mark((function e(){var n,r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.billboardId,e.prev=1,e.next=4,z.findOne({where:{id:n}});case 4:if(r=e.sent){e.next=7;break}throw new Error("Could not find the billboard");case 7:return e.abrupt("return",r);case 10:throw e.prev=10,e.t0=e.catch(1),new Error("Something went wrong",e.t0);case 13:case"end":return e.stop()}}),e,null,[[1,10]])})))()},brands:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in");case 4:if(r){e.next=6;break}throw new Error("We couldn't find a store ID");case 6:return e.prev=6,e.next=9,E(j,r,a.id);case 9:if(e.sent){e.next=12;break}throw new Error("Unauthorized operation");case 12:if(o=V.findAll({where:{storeId:r}})){e.next=15;break}throw new Error("This store has no billboards yet");case 15:return e.abrupt("return",o);case 18:throw e.prev=18,e.t0=e.catch(6),l.log({level:"error",message:"An error occurred for ".concat(a.id," while querying for brands")}),new Error("Something went wrong while getting your brands",e.t0);case 22:case"end":return e.stop()}}),e,null,[[6,18]])})))()},brand:function(e,t,n){return c(i.mark((function e(){var r,a;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.brandId,n.merchant){e.next=3;break}throw new Error("Unauthenticated make sure you are logged in");case 3:return e.prev=3,e.next=6,V.findOne({where:{id:r}});case 6:if(a=e.sent){e.next=9;break}throw new Error("Could not find the brand");case 9:return e.abrupt("return",a);case 12:throw e.prev=12,e.t0=e.catch(3),new Error("Something went wrong",e.t0);case 15:case"end":return e.stop()}}),e,null,[[3,12]])})))()},categories:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,a=n.merchant,r){e.next=4;break}throw new Error("Billboard id is required.");case 4:if(e.prev=4,o=H.findAll({where:{storeId:r}})){e.next=8;break}throw new Error("This billboard has no categories yet");case 8:return e.abrupt("return",o);case 11:throw e.prev=11,e.t0=e.catch(4),l.log({level:"error",message:"An error occurred for ".concat(a.id," while querying for categories")}),new Error("Something went wrong while getting your categories",e.t0);case 15:case"end":return e.stop()}}),e,null,[[4,11]])})))()},category:function(e,t,n){return c(i.mark((function e(){var n,r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.categoryId,e.prev=1,n){e.next=4;break}throw new Error("Category Id is required");case 4:return e.next=6,k(H,n);case 6:if(r=e.sent){e.next=9;break}throw new Error("Could not find the category");case 9:return e.abrupt("return",r);case 12:throw e.prev=12,e.t0=e.catch(1),new Error("Something went wrong",e.t0);case 15:case"end":return e.stop()}}),e,null,[[1,12]])})))()},products:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,a=t.categoryId,o=t.isFeatured,t.isArchived,n.merchant,s={},r&&(s.storeId=r),a&&(s.categoryId=a),o&&(s.isFeatured=o),c=x.findAll({where:s})){e.next=9;break}throw new Error("This billboard has no categories yet");case 9:return e.abrupt("return",c);case 10:case"end":return e.stop()}}),e)})))()},productsIds:function(e,t,n){return c(i.mark((function e(){var n,r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.storeId,r=t.productIds,a={},n&&(a.storeId=n),o=x.findAll({where:{id:r,storeId:n},order:[["updatedAt","ASC"]]})){e.next=6;break}throw new Error("This billboard has no categories yet");case 6:return e.abrupt("return",o);case 7:case"end":return e.stop()}}),e)})))()},productsWithVariants:function(e,t,n){return c(i.mark((function e(){var n,r,a,o,s,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.storeId,r=t.categoryId,a=t.variantId,o=t.isFeatured,t.isArchived,s={},n&&(s.storeId=n),r&&(s.categoryId=r),a&&(s.variantId=a),o&&(s.isFeatured=o),c=x.findAll({where:s,include:[{association:"prodVariations",include:[{association:"prodVarOptions"}]},{association:"prodCombinations",include:[{association:"variantImage"}]}]})){e.next=9;break}throw new Error("This store has no products yet");case 9:return e.abrupt("return",c);case 10:case"end":return e.stop()}}),e)})))()},product:function(e,t,n){return c(i.mark((function e(){var n,r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.productId){e.next=3;break}throw new Error("Product Id is required");case 3:return e.next=5,x.findOne({where:{id:n},include:[{as:"images",model:_},{model:V,as:"brand"},{association:"prodVariations",include:[{association:"prodVarOptions"}]},{association:"prodCombinations",include:[{association:"variantImage"}]}]});case 5:if(r=e.sent){e.next=8;break}throw new Error("Could not find the product");case 8:return e.abrupt("return",r);case 9:case"end":return e.stop()}}),e)})))()},allProducts:function(e,t,n){return c(i.mark((function e(){var t,r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=void 0,e.next=3,n.merchant;case 3:if(r=e.sent){e.next=6;break}throw new Error("Make sure you are logged in to access your products");case 6:return e.next=8,j.findAll({where:{merchantId:r.id},include:{model:x}});case 8:if(t=e.sent){e.next=11;break}throw new Error("Add stores to view them here");case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}}),e)})))()},productSearch:function(e,t,n){return c(i.mark((function e(){var n,r,a,s,c,u,d;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.page,r=t.limit,a=t.text,s=t.storeId,c=[],!(a.length<3)){e.next=4;break}return e.abrupt("return",{products:c});case 4:return u=0,n&&r&&(u=n*r),d={order:[["createdAt","DESC"]],offset:u},r&&(d.limit=r),d.where=o({},I.or,[{name:o({},I.iLike,"%"+a+"%"),storeId:s}]),e.next=11,x.findAll(d);case 11:if(0!==(c=e.sent).length){e.next=14;break}throw new Error('No results found for "'.concat(a,'"'));case 14:return e.abrupt("return",c);case 15:case"end":return e.stop()}}),e)})))()},customerSearch:function(e,n,r){return c(i.mark((function e(){var a,s,c,u,d,p;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.page,s=n.limit,c=n.text,r.merchant){e.next=4;break}throw new Error("Unauthenticated ensure you are logged in first.");case 4:if(u=[],!(c.length<3)){e.next=7;break}return e.abrupt("return",{customers:u});case 7:return d=0,a&&s&&(d=a*s),p={order:[["createdAt","DESC"]],offset:d},s&&(p.limit=s),p.where=o({},I.or,[{first_name:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id},{last_name:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id},{phone_number:o({},I.iLike,"%"+c+"%"),merchantId:r.merchant.id}]),e.next=14,t.findAll(p);case 14:if(0!==(u=e.sent).length){e.next=17;break}throw new Error('No results found for "'.concat(c,'"'));case 17:return e.abrupt("return",u);case 18:case"end":return e.stop()}}),e)})))()},orders:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,n.merchant){e.next=3;break}throw new Error("Unauthenticated please make sure you are logged in.");case 3:return e.next=5,E(j,r,n.merchant.id);case 5:if(a=e.sent){e.next=8;break}throw new Error("Unauthorized operation.");case 8:return o=se.findAll({where:{storeId:a.id},order:[["createdAt","DESC"]],include:[{association:"customerOrder"},{association:"orderItems",include:{association:"orderProduct"}}]}),e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})))()},sales:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,n.merchant){e.next=3;break}throw new Error("Unauthenticated please make sure you are logged in.");case 3:return e.next=5,E(j,r,n.merchant.id);case 5:if(a=e.sent){e.next=8;break}throw new Error("Unauthorized operation.");case 8:return o=he.findAll({where:{storeId:a.id},order:[["createdAt","DESC"]],include:[{association:"customerSales"},{association:"saleDetails",include:{association:"productSales"}}]}),e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})))()},templateSchedules:function(e,t,n){return c(i.mark((function e(){var t;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=pe.findAll({where:{type:"bulkTemplate",timestamp:o({},I.lte,new Date),status:"PENDING"},include:[{association:"bulkTempTask"},{association:"merchantsTasks"}]}),e.abrupt("return",t);case 2:case"end":return e.stop()}}),e)})))()},promotions:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,n.merchant){e.next=3;break}throw new Error("Unauthenticated please make sure you are logged in.");case 3:return e.next=5,E(j,r,n.merchant.id);case 5:if(a=e.sent){e.next=8;break}throw new Error("Unauthorized operation.");case 8:return o=le.findAll({where:{storeId:a.id},include:["coupon","storePromotions"],order:[["createdAt","DESC"]]}),e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})))()}},RootMutation:{addCustomer:function(e,r,a){return c(i.mark((function e(){var o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.customer,e.next=3,n.findOne({where:{id:a.merchant.id}});case 3:return s=e.sent,e.next=6,t.findOne({where:{phone_number:o.phone_number,merchantId:s.id}});case 6:if(!e.sent){e.next=11;break}throw new Error("Customer of phone number ".concat(o.phone_number," already exists."));case 11:return e.next=13,t.create(p({},o),{include:["customerLoyalty"]}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([t.setMerchant(s.id)]);case 2:return l.log({level:"info",message:"Customer was created"}),e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 13:return e.abrupt("return",e.sent);case 14:case"end":return e.stop()}}),e)})))()},updateCustomer:function(e,n,r){return c(i.mark((function e(){var a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.customerId,o=n.payload,r.merchant){e.next=3;break}throw new Error("Unauthenticated please make sure you are logged in");case 3:if(a){e.next=5;break}throw new Error("Unathorized operation customer Id and the new names is required");case 5:return e.next=7,C(t,a,r.merchant.id);case 7:if(s=e.sent){e.next=10;break}throw new Error("Unathorized operation could not find the customer");case 10:return e.prev=10,e.next=13,t.update(p(p({},s),{},{first_name:o.first_name,last_name:o.last_name,phone_number:o.phone_number}),{where:{id:parseInt(a),merchantId:r.merchant.id},returning:!0,plain:!0}).then((function(e){return e[1]}));case 13:e.sent,e.next=21;break;case 16:if(e.prev=16,e.t0=e.catch(10),"not_unique"!==e.t0.validatorKey){e.next=20;break}throw new Error("A customer of the given phone ".concat(o.name," already exists"));case 20:l.log({level:"error",message:"update customer for ".concat(r.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 21:return e.abrupt("return",s);case 22:case"end":return e.stop()}}),e,null,[[10,16]])})))()},addChat:function(e,t,n){return c(i.mark((function e(){var r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.chat,e.next=3,d.findOne({where:{merchantId:n.merchant.id,customerId:r.customer}});case 3:if(!e.sent){e.next=9;break}return e.next=7,d.update(p({},r),{where:{merchantId:n.merchant.id,customerId:r.customer}}).then((function(e){return l.log({level:"info",message:"Updated an existing chat"}),e}));case 7:e.next=12;break;case 9:return e.next=11,d.create().then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setCustomer(r.customer),t.setMerchant(n.merchant)]).then((function(){return l.log({level:"info",message:"Chat was created"}),$.publish("chatAdded",{chatAdded:t,merchantId:r.merchantId}),t})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e)})))()},addTextMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,m,h,f,g,I,v,b,w,x,E;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.participants,u=r.customerId,m=r.template,h=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:s,message:o,context:a,customerId:u,template:m,Message:y,contextMessage:h});case 3:return f=e.sent,g=f.customer,I=f.merchant,v=f.chat,b=f.addNewChat,w=f.messageId,x=f.contextedMessage,e.next=12,y.create(p(p({},o.message),{},w?{text:o.text,messageId:w,hasContext:!!x,contextId:x?x.id:null}:{text:o.text,hasContext:!!x,contextId:x?x.id:null}),{include:["text"]}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(v.id),t.setMerchant(I.id),t.setCustomer(g.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===b&&$.publish("chatAdded",{chatAdded:v,merchantId:v.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),l.log({level:"info",message:"Message was created ".concat((new Date).toDateString())}),e.next=5,d.update(p(p({},v),{},{createdAt:v.createdAt}),{where:{merchantId:I.id,customerId:g.id},silent:!1}).then((function(e){return l.log({level:"info",message:"chat updated"}),e}));case 5:return e.sent,e.abrupt("return",t);case 7:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return E=e.sent,e.abrupt("return",E);case 14:case"end":return e.stop()}}),e)})))()},addImageMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w,x;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.template,u=r.customerId,l=r.participants,m=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:l,message:o,context:a,customerId:u,template:s,Message:y,contextMessage:m});case 3:return h=e.sent,f=h.customer,g=h.merchant,I=h.chat,v=h.addNewChat,b=h.messageId,w=h.contextedMessage,e.next=12,y.create(p(p({},o.message),{},b?{image:o.image,messageId:b,hasContext:!!w,contextId:w?w.id:null}:{image:o.image,hasContext:!!w,contextId:w?w.id:null}),{include:["image"]}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(I.id),t.setMerchant(g.id),t.setCustomer(f.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===v&&$.publish("chatAdded",{chatAdded:I,merchantId:I.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},I),{},{createdAt:I.createdAt}),{where:{merchantId:g.id,customerId:f.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return x=e.sent,e.abrupt("return",x);case 14:case"end":return e.stop()}}),e)})))()},addDocumentMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w,x;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.template,u=r.customerId,l=r.participants,m=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:l,message:o,context:a,customerId:u,template:s,Message:y,contextMessage:m});case 3:return h=e.sent,f=h.customer,g=h.merchant,I=h.chat,v=h.addNewChat,b=h.messageId,w=h.contextedMessage,e.next=12,y.create(p(p({},o.message),{},b?{document:o.document,messageId:b,hasContext:!!w,contextId:w?w.id:null}:{document:o.document,hasContext:!!w,contextId:w?w.id:null}),{include:["document"]}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(I.id),t.setMerchant(g.id),t.setCustomer(f.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===v&&$.publish("chatAdded",{chatAdded:I,merchantId:I.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},I),{},{createdAt:I.createdAt}),{where:{merchantId:g.id,customerId:f.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return x=e.sent,e.abrupt("return",x);case 14:case"end":return e.stop()}}),e)})))()},addVideoMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w,x;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.template,u=r.customerId,l=r.participants,m=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:l,message:o,context:a,customerId:u,template:s,Message:y,contextMessage:m});case 3:return h=e.sent,f=h.customer,g=h.merchant,I=h.chat,v=h.addNewChat,b=h.messageId,w=h.contextedMessage,e.next=12,y.create(p(p({},o.message),{},b?{video:o.video,messageId:b,hasContext:!!w,contextId:w?w.id:null}:{video:o.video,hasContext:!!w,contextId:w?w.id:null}),{include:["video"]}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(I.id),t.setMerchant(g.id),t.setCustomer(f.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===v&&$.publish("chatAdded",{chatAdded:I,merchantId:I.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},I),{},{createdAt:I.createdAt}),{where:{merchantId:g.id,customerId:f.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return x=e.sent,e.abrupt("return",x);case 14:case"end":return e.stop()}}),e)})))()},addInteractiveButtonMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.customerId,u=r.template,l=r.participants,m=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:l,message:o,context:a,customerId:s,template:u,Message:y,contextMessage:m});case 3:return h=e.sent,f=h.customer,g=h.merchant,I=h.chat,v=h.addNewChat,b=h.messageId,h.contextedMessage,e.next=12,y.create(p(p({},o.message),{},b?{interactive:o.interactive,messageId:b}:{interactive:o.interactive}),{include:{association:"interactive",include:{association:"button",include:["btnImageHead","buttons","btnTextHead"]}}}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(I.id),t.setMerchant(g.id),t.setCustomer(f.id),t.interactive.button.setProduct(t.interactive.button.productId)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===v&&$.publish("chatAdded",{chatAdded:I,merchantId:I.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},I),{},{createdAt:I.createdAt}),{where:{merchantId:g.id,customerId:f.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return w=e.sent,e.abrupt("return",w);case 14:case"end":return e.stop()}}),e)})))()},addInteractiveTemplateMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.customerId,u=r.template,l=r.participants,m=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:l,message:o,context:a,customerId:s,template:u,Message:y,contextMessage:m});case 3:return h=e.sent,f=h.customer,g=h.merchant,I=h.chat,v=h.addNewChat,b=h.messageId,h.contextedMessage,e.next=12,y.create(p(p({},o.message),{},b?{interactive:o.interactive,messageId:b}:{interactive:o.interactive}),{include:{association:"interactive",include:{association:"template",include:["tempImageHead","buttons","tempTextHead"]}}}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(I.id),t.setMerchant(g.id),t.setCustomer(f.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===v&&$.publish("chatAdded",{chatAdded:I,merchantId:I.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},I),{},{createdAt:I.createdAt}),{where:{merchantId:g.id,customerId:f.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return w=e.sent,e.abrupt("return",w);case 14:case"end":return e.stop()}}),e)})))()},addInteractiveListMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.customerId,u=r.participants,l=r.contextMessage,m=r.template,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:u,message:o,context:a,customerId:s,template:m,Message:y,contextMessage:l});case 3:return h=e.sent,f=h.customer,g=h.merchant,I=h.chat,v=h.addNewChat,b=h.messageId,h.contextedMessage,e.next=12,y.create(p(p({},o.message),{},b?{interactive:o.interactive,messageId:b}:{interactive:o.interactive}),{include:{association:"interactive",include:{association:"list",include:[{model:ie,as:"listTextHead"},{model:ne,as:"sections",include:["rows"]}]}}}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(I.id),t.setMerchant(g.id),t.setCustomer(f.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===v&&$.publish("chatAdded",{chatAdded:I,merchantId:I.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},I),{},{createdAt:I.createdAt}),{where:{merchantId:g.id,customerId:f.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return w=e.sent,e.abrupt("return",w);case 14:case"end":return e.stop()}}),e)})))()},addButtonRepliedMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.participants,u=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:s,message:o,context:a,Message:y,contextMessage:u,InteractiveMessage:Q,InteractiveButton:J});case 3:return l=e.sent,m=l.customer,h=l.merchant,f=l.chat,g=l.addNewChat,I=l.messageId,v=l.contextedMessage,o.mesBtnReply.interactiveButtonId=v.interactive.button.id,e.next=13,y.create(p(p({},o.message),{},I?{mesBtnReply:o.mesBtnReply,messageId:I,hasContext:!!v,contextId:v?v.id:null}:{mesBtnReply:o.mesBtnReply,hasContext:!!v,contextId:v?v.id:null}),{include:{association:"mesBtnReply"}}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(f.id),t.setMerchant(h.id),t.setCustomer(m.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===g&&$.publish("chatAdded",{chatAdded:f,merchantId:f.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},f),{},{createdAt:f.createdAt}),{where:{merchantId:h.id,customerId:m.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 13:return b=e.sent,v.isAd&&U({Ad:ce,merchantId:h.id,adId:v.adId}),e.abrupt("return",b);case 16:case"end":return e.stop()}}),e)})))()},addTemplateRepliedMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.message,s=r.participants,u=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:s,message:o,context:a,Message:y,contextMessage:u,InteractiveMessage:Q,InteractiveTemplate:Z});case 3:return l=e.sent,m=l.customer,h=l.merchant,f=l.chat,g=l.addNewChat,I=l.messageId,v=l.contextedMessage,o.mesTempReply.interactiveTemplateId=null==v?void 0:v.interactive.template.id,e.next=13,y.create(p(p({},o.message),{},I?{mesTempReply:o.mesTempReply,messageId:I,hasContext:!!v,contextId:v?v.id:null}:{mesTempReply:o.mesTempReply,hasContext:!!v,contextId:v?v.id:null}),{include:{association:"mesTempReply"}}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(f.id),t.setMerchant(h.id),t.setCustomer(m.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===g&&$.publish("chatAdded",{chatAdded:f,merchantId:f.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},f),{},{createdAt:f.createdAt}),{where:{merchantId:h.id,customerId:m.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 13:if(b=e.sent,!v.isAd){e.next=17;break}return e.next=17,U({Ad:ce,merchantId:h.id,adId:v.adId,MarketingResponse:de,response:{customerId:m.id,messageId:b.id,productId:null==v||null===(w=v.interactive)||void 0===w||null===(w=w.template)||void 0===w?void 0:w.productId}});case 17:return e.abrupt("return",b);case 18:case"end":return e.stop()}}),e)})))()},addListRepliedMessage:function(e,r,a){return c(i.mark((function e(){var o,s,u,l,m,h,f,g,I,v,b,w,x;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.message,u=r.participants,l=r.contextMessage,e.next=3,L({Merchant:n,Customer:t,Chat:d,participants:u,message:s,context:a,Message:y,contextMessage:l,InteractiveMessage:Q,InteractiveList:ee,ListSection:ne});case 3:return m=e.sent,h=m.customer,f=m.merchant,g=m.chat,I=m.addNewChat,v=m.messageId,b=m.contextedMessage,w=void 0,null==b||null===(o=b.interactive)||void 0===o||null===(o=o.list)||void 0===o||null===(o=o.sections)||void 0===o||o.every((function(e){var t;return null==e||null===(t=e.rows)||void 0===t||t.every((function(e){return(null==e?void 0:e.buttonId)!==s.mesListReply.buttonId||(w=null==e?void 0:e.id,!1)})),!w})),s.mesListReply.listRowButtonId=w,e.next=15,y.create(p(p({},s.message),{},v?{mesListReply:s.mesListReply,messageId:v,hasContext:!!b,contextId:b?b.id:null}:{mesListReply:s.mesListReply,hasContext:!!b,contextId:b?b.id:null}),{include:{association:"mesListReply"}}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setChat(g.id),t.setMerchant(f.id),t.setCustomer(h.id)]).then(c(i.mark((function e(){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!0===I&&$.publish("chatAdded",{chatAdded:g,merchantId:g.merchantId}),$.publish("messageAdded",{messageAdded:{message:t},chatId:t.chatId}),e.next=4,d.update(p(p({},g),{},{createdAt:g.createdAt}),{where:{merchantId:f.id,customerId:h.id},silent:!1}).then((function(e){return e}));case 4:return e.sent,e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 15:return x=e.sent,b.isAd&&U({Ad:ce,merchantId:f.id,adId:b.adId}),e.abrupt("return",x);case 18:case"end":return e.stop()}}),e)})))()},addTemplateMesBulk:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,u,h,f,g,I,v,b,w;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.message,a=t.selectedCustomers,o=t.template,s=n.merchant,u=!1,h=null,s){e.next=6;break}throw new Error("Unauthenticated you need to be logged in!");case 6:return f=JSON.parse(a),g=JSON.parse(o),e.next=10,s.getSetting();case 10:if(I=(I=e.sent).dataValues){e.next=14;break}throw new Error("We could not find you Whatsapp business Setting make sure you add the settings before sending any message.");case 14:return v=void 0,b=void 0,e.prev=16,e.next=19,ue.create({name:g.template.name,productId:null===(w=r.interactive.template)||void 0===w?void 0:w.productId}).then((function(e){return e.setMerchant(s.id),e}));case 19:if(!(v=e.sent)){e.next=26;break}return e.next=23,ce.create().then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([t.setMerchant(s.id),t.setAdTemplate(v.id)]);case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 23:if(b=e.sent){e.next=26;break}throw new Error("An error occured while creating your marketing campaign please try again later or contact us");case 26:e.next=33;break;case 28:throw e.prev=28,e.t0=e.catch(16),console.log(e.t0),l.log({level:"error",message:"[ERROR CREATING AD FOR MERCHANT], ".concat(s.id)}),new Error("An error occured while creating your marketing campaign please try again later or contact us");case 33:f.forEach(function(){var e=c(i.mark((function e(t){var n,a,o,f;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,g.to=t.phone_number,e.next=4,m(g,I);case 4:if(n=e.sent,!(a=n.data)){e.next=28;break}return h=a.messages[0].id,e.prev=8,e.next=11,D(d,t.id,s.id);case 11:if(o=e.sent){e.next=17;break}return e.next=15,G(d,t.id,s.id);case 15:o=e.sent,u=!0;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(8),l.log({level:"error",message:"Could not create chat before sending bulk message for ".concat((t.id,s.id))});case 22:return e.next=24,y.create(p(p({},r.message),{},h?{chatId:o.id,interactive:r.interactive,messageId:h,isAd:!0,adId:b.id}:{chatId:o.id,interactive:r.interactive,isAd:!0,adId:b.id}),{include:{association:"interactive",include:{association:"template",include:["tempImageHead","buttons","tempTextHead"]}}}).then(function(){var e=c(i.mark((function e(n){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([n.setChat(o.id),n.setMerchant(s.id),n.setCustomer(t.id)]).then(c(i.mark((function e(){var t;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0===u&&$.publish("chatAdded",{chatAdded:o,merchantId:o.merchantId}),$.publish("messageAdded",{messageAdded:{message:n},chatId:n.chatId}),null!==(t=v)&&void 0!==t&&t.messageId){e.next=5;break}return e.next=5,ue.update(p(p({},v),{},{messageId:n.id}),{where:{id:v.id}});case 5:return e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 24:return f=e.sent,e.abrupt("return",f);case 28:return e.next=30,ce.update(p(p({},b),{},{failed:null!==b.failed?b.failed+=1:1}),{where:{id:b.id},silent:!1});case 30:e.sent;case 31:e.next=39;break;case 33:return e.prev=33,e.t1=e.catch(0),l.log({level:"error",message:"[ERROR SENDING MESSAGE TO CUSTOMER] for ".concat(s.id," bulk message")}),e.next=38,ce.update(p(p({},b),{},{failed:null!==b.failed?b.failed+=1:1}),{where:{id:b.id},returning:!0,plain:!0}).then((function(e){return e[1]}));case 38:b=e.sent;case 39:case"end":return e.stop()}}),e,null,[[0,33],[8,19]])})));return function(t){return e.apply(this,arguments)}}());case 34:case"end":return e.stop()}}),e,null,[[16,28]])})))()},addSetting:function(e,t,n){return c(i.mark((function e(){var r,a;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.setting,a=n.merchant){e.next=4;break}throw new Error("not_allowed");case 4:return r.callBack_url="".concat(process.env.WEBHOOK_BASE_URL,"/incoming?username=").concat(a.username),e.next=7,w.findOne({where:{merchantId:a.id}});case 7:if(!e.sent){e.next=13;break}return e.next=11,w.update(p({},r),{where:{merchantId:a.id}}).then((function(e){return l.log({level:"info",message:"setting updated"}),e}));case 11:e.next=14;break;case 13:return e.abrupt("return",w.create(p({},r)).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Promise.all([t.setMerchant(a.id)]),l.log({level:"info",message:"Setting created"}),e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 14:case"end":return e.stop()}}),e)})))()},addStore:function(e,t,n){return c(i.mark((function e(){var r,a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.store,!(a=n.merchant)){e.next=12;break}return e.next=5,j.findOne({where:{name:r.name,merchantId:a.id}});case 5:if(!(o=e.sent)){e.next=8;break}throw new Error('Store of name "'.concat(o.name,'" already exists. Use a different name to create a new store'));case 8:return e.next=10,j.create(p({},r)).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([t.setMerchant(a.id)]).then((function(){return l.log({level:"info",message:"Store of merchant ".concat(a.id)}),t})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 10:return s=e.sent,e.abrupt("return",s);case 12:case"end":return e.stop()}}),e)})))()},updateStore:function(e,t,n){return c(i.mark((function e(){var r,a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthenticated please make sure you are logged in");case 3:if(r){e.next=5;break}throw new Error("Unathorized operation store Id and the new name required");case 5:return e.next=7,E(j,r,n.merchant.id);case 7:if(o=e.sent){e.next=10;break}throw new Error("Unathorized operation could not find the store");case 10:return e.next=12,M(j,a.name,n.merchant.id);case 12:if(!(s=e.sent)){e.next=16;break}if(o.id===s.id){e.next=16;break}throw new Error('Store of name "'.concat(a.name,'" already exists.'));case 16:return e.prev=16,e.next=19,j.update(p(p({},o),{},{name:a.name}),{where:{id:parseInt(r),merchantId:n.merchant.id}});case 19:if(0!==e.sent[0]){e.next=22;break}throw new Error("Update failed");case 22:return e.next=24,E(j,r,n.merchant.id);case 24:o=e.sent,e.next=33;break;case 27:if(e.prev=27,e.t0=e.catch(16),console.log("[UPDATING STORE ERROR]",e.t0),"not_unique"!==e.t0.validatorKey){e.next=32;break}throw new Error("A store of the give name ".concat(a.name," already exists"));case 32:l.log({level:"error",message:"update store for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 33:return e.abrupt("return",o);case 34:case"end":return e.stop()}}),e,null,[[16,27]])})))()},deleteStore:function(e,t,n){return c(i.mark((function e(){var r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:return e.next=5,E(j,r,n.merchant.id);case 5:if(e.sent){e.next=8;break}throw new Error("Unauthorized operation");case 8:return e.prev=8,e.next=11,j.destroy({where:{id:r,merchantId:n.merchant.id}});case 11:e.sent,e.next=18;break;case 14:return e.prev=14,e.t0=e.catch(8),console.log(e.t0),e.abrupt("return",!1);case 18:return e.abrupt("return",!0);case 19:case"end":return e.stop()}}),e,null,[[8,14]])})))()},addMpesa:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.mpesa,a=n.merchant){e.next=4;break}throw new Error("Unathenticated please make sure you are logged in.");case 4:return e.next=6,E(j,r.storeId,a.id);case 6:if(e.sent){e.next=9;break}throw new Error("Unauthorized operation.");case 9:return e.next=11,fe.findOne({where:{storeId:r.storeId}});case 11:if(!e.sent){e.next=14;break}throw new Error("A store can only have one Mpesa payment service. ${store.name} has an existing payment service. Update or delete.");case 14:return e.prev=14,e.next=17,fe.create(p({},r));case 17:return o=e.sent,e.abrupt("return",o);case 21:throw e.prev=21,e.t0=e.catch(14),l.log({level:"error",message:"Failed to create mpesa for ".concat(a.id)}),new Error("Failed to create mpesa settings.");case 25:case"end":return e.stop()}}),e,null,[[14,21]])})))()},updateMpesa:function(e,t,n){return c(i.mark((function e(){var r,a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.mpesaId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthenticated please make sure you are logged in");case 3:if(a.storeId){e.next=5;break}throw new Error("Store Id is required");case 5:return e.next=7,E(j,a.storeId,n.merchant.id);case 7:if(e.sent){e.next=10;break}throw new Error("Unathorized operation could not find the store");case 10:if(o=fe.findOne({where:{id:r,storeId:a.storeId}})){e.next=13;break}throw new Error("Could of find Mpesa settings");case 13:return e.prev=13,e.next=16,fe.update(p(p({},o),{},{consumer_key:a.consumer_key,consumer_secret:a.consumer_secret,pass_key:a.pass_key,business_shortcode:a.business_shortcode,account_reference:a.account_reference,transaction_desc:a.transaction_desc,callBack_url:a.callBack_url}),{where:{id:parseInt(r),storeId:a.storeId},returning:!0,plain:!0}).then((function(e){return e[1]}));case 16:return s=e.sent,e.abrupt("return",s);case 20:e.prev=20,e.t0=e.catch(13),l.log({level:"error",message:"update mpesa for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 23:case"end":return e.stop()}}),e,null,[[13,20]])})))()},deleteMpesa:function(e,t,n){return c(i.mark((function e(){var r,a;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.mpesaId,a=t.storeId,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:return e.next=5,E(j,a,n.merchant.id);case 5:if(e.sent){e.next=8;break}throw new Error("Unauthorized operation");case 8:return e.prev=8,e.next=11,fe.destroy({where:{storeId:a,id:r}});case 11:e.next=16;break;case 13:return e.prev=13,e.t0=e.catch(8),e.abrupt("return","failed");case 16:return e.abrupt("return","success");case 17:case"end":return e.stop()}}),e,null,[[8,13]])})))()},updateChatStatus:function(e,r,a){return c(i.mark((function e(){var a,s,c,u,m,h,f;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.participants,s=r.payload,c=null,u=null,m=null,h=null,e.prev=5,e.next=8,n.findOne({where:{username:a.mer_username}});case 8:return c=e.sent,e.next=11,t.findOne({where:{phone_number:a.customer.phone_number,merchantId:c.id}});case 11:if((u=e.sent)&&c){e.next=16;break}l.log({level:"error",message:'"Could not find merchant or customer" '.concat(a.mer_username," ").concat(a.customer.phone_number,"} ")}),e.next=46;break;case 16:return e.next=18,y.findOne({where:{merchantId:parseInt(c.id),customerId:parseInt(u.id),messageId:s.messageId}});case 18:if(!(m=e.sent)){e.next=39;break}return e.next=22,y.update(p(p({},m),{},{status:"read"===m.status?"read":"delivered"===m.status?"delivered":s.status}),{where:{id:m.id},silent:!1});case 22:if(0!==e.sent[0]){e.next=28;break}return l.log({level:"error",message:"Update failed for message of ".concat(c.id," and customer ").concat(u.id)}),e.abrupt("return");case 28:return e.next=30,y.findOne({where:{id:m.id,merchantId:c.id,customerId:u.id}});case 30:m=e.sent;case 31:if($.publish("messageAdded",{messageAdded:{message:m},chatId:m.chatId}),!m.isAd){e.next=39;break}return e.next=35,P(ce,c.id,m.adId);case 35:return f=e.sent,e.next=38,ce.update(p(p({},f),{},o({},m.status,null!==f["".concat(m.status)]?f["".concat(m.status)]+=1:1)),{where:{id:f.id},silent:!1});case 38:e.sent;case 39:return e.next=41,D(d,u.id,c.id);case 41:if(!(h=e.sent)||!s.conversationId){e.next=46;break}return e.next=45,d.update(p(p({},h),{},{status:"opened",conversationId:s.conversationId}),{where:{merchantId:c.id,customerId:u.id},silent:!1});case 45:h=e.sent;case 46:e.next=51;break;case 48:e.prev=48,e.t0=e.catch(5),console.log("[AN ERROR WHILE UPDATING MESSAGE]",e.t0);case 51:case"end":return e.stop()}}),e,null,[[5,48]])})))()},updateMessageStatus:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.id,a=t.messageId,!(o=n.merchant)){e.next=23;break}return e.prev=3,s=!1,e.next=7,y.findOne({where:{id:r,messageId:a}});case 7:if(!(u=e.sent)||"read"===u.status){e.next=18;break}return e.next=11,y.update(p(p({},u),{},{status:"read"}),{where:{id:r,messageId:a},silent:!1});case 11:return result=e.sent,s=!0,0===result[0]&&l.log({level:"error",message:'"updating message failed" "'.concat(u.merchantId,'"')}),e.next=16,y.findOne({where:{id:u.id},include:[{model:F,as:"text"},{model:Y,as:"image"}]}).then(function(){var e=c(i.mark((function e(t){var n,r;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==s){e.next=10;break}return e.next=3,o.getSetting();case 3:return n=(n=e.sent).dataValues,(r=q.read).message_id=a,e.next=9,m(r,n);case 9:e.sent;case 10:return e.abrupt("return",t);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:return u=e.sent,e.abrupt("return",u);case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(3),console.log("[AN ERROR WHILE UPDATING MESSAGE]");case 23:case"end":return e.stop()}}),e,null,[[3,20]])})))()},addBillboard:function(e,t,n){return c(i.mark((function e(){var r,a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.billboard,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to create a billboard");case 4:return e.next=6,E(j,r.storeId,n.merchant.id);case 6:if(o=e.sent){e.next=9;break}throw new Error("Unauthorized operation");case 9:return e.next=11,z.findOne({where:{storeId:o.id,label:r.label}});case 11:if(!e.sent){e.next=14;break}throw new Error("Billboard of name ".concat(r.label," already exists."));case 14:return e.prev=14,e.next=17,z.create(p({},r));case 17:return s=e.sent,e.abrupt("return",s);case 21:throw e.prev=21,e.t0=e.catch(14),l.log({level:"error",message:"An error occured while creating billboard for ".concat(a.id," at ").concat((new Date).toLocaleDateString())}),new Error("Could not create a billboard try again later",e.t0);case 25:case"end":return e.stop()}}),e,null,[[14,21]])})))()},updateBillboard:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.billboardId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:if(r){e.next=5;break}throw new Error("Billboard id is required");case 5:if(a.storeId){e.next=7;break}throw new Error("Unauthorized operation");case 7:return e.next=9,E(j,a.storeId,n.merchant.id);case 9:if(o=e.sent){e.next=12;break}throw new Error("Unauthorized operation");case 12:return e.next=14,z.findOne({where:{id:r,storeId:o.id}});case 14:if(s=e.sent){e.next=17;break}throw new Error("Could not find the billboard");case 17:return e.next=19,N(z,a.label,o.id);case 19:if(!(c=e.sent)){e.next=23;break}if(s.id===c.id){e.next=23;break}throw new Error('Billboard of name "'.concat(a.label,'" already exists.'));case 23:if(e.prev=23,a.label){e.next=26;break}throw new Error("Label is required");case 26:if(a.imageUrl){e.next=28;break}throw new Error("Image Url is required");case 28:return e.next=30,z.update(p(p({},s),{},{label:a.label,imageUrl:a.imageUrl}),{where:{id:parseInt(s.id),storeId:s.storeId}});case 30:if(0!==e.sent[0]){e.next=33;break}throw new Error("Update failed.");case 33:return e.next=35,T(z,r);case 35:return u=e.sent,e.abrupt("return",u);case 39:if(e.prev=39,e.t0=e.catch(23),console.log("[UPDATING BILLBOARD ERROR]",e.t0),"not_unique"!==e.t0.validatorKey){e.next=44;break}throw new Error("A billboard of the give name ".concat(a.name," already exists"));case 44:l.log({level:"error",message:"update store for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 45:case"end":return e.stop()}}),e,null,[[23,39]])})))()},deleteBillboard:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.billboardId,a=t.storeId,console.log("DELETING BILLBOARD",r,a),n.merchant.id){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in");case 4:if(r){e.next=6;break}throw new Error("Billboard ID is requreid");case 6:if(a){e.next=8;break}throw new Error("Unauthorized operation store Id does not match");case 8:return e.next=10,E(j,a,n.merchant.id);case 10:if(o=e.sent){e.next=13;break}throw new Error("Unauthaurized operation");case 13:return e.next=15,z.findOne({where:{id:r,storeId:o.id}});case 15:if(e.sent){e.next=18;break}throw new Error("Could not find the billboard.");case 18:return e.prev=18,e.next=21,z.destroy({where:{id:r}});case 21:e.sent,e.next=28;break;case 24:return e.prev=24,e.t0=e.catch(18),console.log(e.t0),e.abrupt("return",!1);case 28:return e.abrupt("return",!0);case 29:case"end":return e.stop()}}),e,null,[[18,24]])})))()},addBrand:function(e,t,n){return c(i.mark((function e(){var r,a,o,c,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.brand,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a brand");case 4:if(r.storeId){e.next=6;break}throw new Error("Store Id is required");case 6:return e.next=8,E(j,r.storeId,a.id);case 8:if(o=e.sent){e.next=11;break}throw new Error("Unauthorized operation");case 11:return e.next=13,H.findOne({where:{name:r.name,storeId:o.id}});case 13:if(!(c=e.sent)){e.next=16;break}throw new Error("Brand of name ".concat(c.name," already exists."));case 16:return e.prev=16,e.next=19,V.create(p({},r)).then((function(e){return e.setStore(o.id),e}));case 19:return u=e.sent,e.abrupt("return",u);case 23:if(e.prev=23,e.t0=e.catch(16),"SequelizeUniqueConstraintError"!==e.t0.name){e.next=29;break}throw new Error("Brand of name ".concat(r.name," already exists."));case 29:throw l.log({level:"error",message:"An error occured while creating brand for ".concat(a.id," at ").concat((new Date).toLocaleDateString())}),s,e.t0;case 32:case"end":return e.stop()}}),e,null,[[16,23]])})))()},updateBrand:function(e,t,n){return c(i.mark((function e(){var r,a,o,c,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.brandId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:if(r){e.next=7;break}throw new Error("Brand id is required.");case 7:if(a.storeId){e.next=9;break}throw new Error("Store id is required");case 9:return e.next=11,E(j,a.storeId,n.merchant.id);case 11:if(o=e.sent){e.next=14;break}throw new Error("Unauthorized operation.");case 14:return e.next=16,V.findOne({where:{id:r,storeId:o.id}});case 16:if(c=e.sent){e.next=19;break}throw new Error("Could not find the brand.");case 19:return e.prev=19,e.next=22,V.update(p(p({},c),{},{name:a.name,joinDate:a.joinDate,description:a.description,phoneNumber:a.phoneNumber,industry:a.industry,loc_name:a.loc_name,loc_address:a.loc_address,loc_latitude:a.loc_address,loc_url:a.loc_url}),{where:{id:parseInt(r)},returning:!0,plain:!0}).then((function(e){return e[1]}));case 22:return u=e.sent,e.abrupt("return",u);case 26:if(e.prev=26,e.t0=e.catch(19),"SequelizeUniqueConstraintError"!==e.t0.name){e.next=32;break}throw new Error("Brand of name ".concat(a.name," already exists."));case 32:throw l.log({level:"error",message:"An error occured while updating brand for ".concat(n.merchant.id," at ").concat((new Date).toLocaleDateString())}),s,e.t0;case 35:case"end":return e.stop()}}),e,null,[[19,26]])})))()},deleteBrand:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.brandId,a=t.storeId,n.merchant.id){e.next=3;break}throw new Error("Unauthenticated make sure you are logged in");case 3:if(r){e.next=5;break}throw new Error("Brand ID is requreid");case 5:if(a){e.next=7;break}throw new Error("Store Id id required");case 7:return e.next=9,E(j,a,n.merchant.id);case 9:if(o=e.sent){e.next=12;break}throw new Error("Unauthaurized operation");case 12:return e.prev=12,e.next=15,V.destroy({where:{id:r,storeId:o.id}});case 15:e.next=20;break;case 17:return e.prev=17,e.t0=e.catch(12),e.abrupt("return","failed");case 20:return e.abrupt("return","success");case 21:case"end":return e.stop()}}),e,null,[[12,17]])})))()},addCategory:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.category,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r.name){e.next=8;break}throw new Error("Category name is required");case 8:if(r.billboardId){e.next=10;break}throw new Error("Billboard Id is required");case 10:return e.next=12,T(z,r.billboardId);case 12:if(o=e.sent){e.next=15;break}throw new Error("Could not find the billboard");case 15:return e.next=17,E(j,o.storeId,a.id);case 17:if(s=e.sent){e.next=20;break}throw new Error("Unauthorized operation");case 20:return e.next=22,H.findOne({where:{name:r.name,billboardId:r.billboardId,storeId:s.id}});case 22:if(!(c=e.sent)){e.next=25;break}throw new Error("Category of name ".concat(c.name," already exists."));case 25:return e.prev=25,e.next=28,H.create(p({},r)).then((function(e){return e.setStore(s.id),e}));case 28:return u=e.sent,e.abrupt("return",u);case 32:throw e.prev=32,e.t0=e.catch(25),l.log({level:"error",message:"An error occured while creating category for ".concat(a.id," at ").concat((new Date).toLocaleDateString())}),new Error("Could not create a category try again later",e.t0);case 36:case"end":return e.stop()}}),e,null,[[25,32]])})))()},updateCategory:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.categoryId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:if(r){e.next=7;break}throw new Error("Cateory id is required.");case 7:if(a.name){e.next=11;break}throw new Error("A name is required");case 11:if(a.billboardId){e.next=13;break}throw new Error("Billboard id is required");case 13:return e.next=15,H.findOne({where:{id:r}});case 15:if(o=e.sent){e.next=18;break}throw new Error("Could not find the category.");case 18:return e.next=20,T(z,a.billboardId);case 20:if(s=e.sent){e.next=23;break}throw new Error("Could not find billboard.");case 23:return e.next=25,E(j,s.storeId,n.merchant.id);case 25:if(e.sent){e.next=28;break}throw new Error("Unauthorized operation.");case 28:return e.next=30,O(H,a.name,s.id);case 30:if(!(c=e.sent)){e.next=34;break}if(o.id===c.id){e.next=34;break}throw new Error('Category of name "'.concat(a.name,'" already exists for this store.'));case 34:return e.prev=34,e.next=37,H.update(p(p({},o),{},{name:a.name,billboardId:a.billboardId}),{where:{id:parseInt(r)}});case 37:if(0!==e.sent[0]){e.next=40;break}throw new Error("Update failed");case 40:return e.next=42,k(H,r);case 42:return u=e.sent,e.abrupt("return",u);case 46:if(e.prev=46,e.t0=e.catch(34),console.log("[UPDATING BILLBOARD ERROR]",e.t0),"not_unique"!==e.t0.validatorKey){e.next=51;break}throw new Error("A category of the given name ".concat(a.name," already exists"));case 51:l.log({level:"error",message:"update store for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 52:case"end":return e.stop()}}),e,null,[[34,46]])})))()},deleteCategory:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.categoryId,a=t.storeId,console.log("DELETING BILLBOARD",r,a),n.merchant.id){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in");case 4:if(r){e.next=6;break}throw new Error("Category ID is requreid");case 6:if(a){e.next=8;break}throw new Error("Store Id id required");case 8:return e.next=10,E(j,a,n.merchant.id);case 10:if(o=e.sent){e.next=13;break}throw new Error("Unauthaurized operation");case 13:return e.prev=13,e.next=16,H.destroy({where:{id:r,storeId:o.id}});case 16:e.sent,e.next=23;break;case 19:return e.prev=19,e.t0=e.catch(13),console.log(e.t0),e.abrupt("return",!1);case 23:return e.abrupt("return",!0);case 24:case"end":return e.stop()}}),e,null,[[13,19]])})))()},addProduct:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.product,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r.name){e.next=8;break}throw new Error("Product name is required");case 8:if(r.price){e.next=12;break}throw new Error("product price is required");case 12:if(r.categoryId){e.next=16;break}throw new Error("Product's category id is required");case 16:if(r.storeId){e.next=20;break}throw new Error("Product's store id is required");case 20:if(r.images&&r.images.length){e.next=22;break}throw new Error("Product images is required.");case 22:return e.next=24,E(j,r.storeId,a.id);case 24:if(o=e.sent){e.next=27;break}throw new Error("Unauthorized operation.");case 27:return e.next=29,x.findOne({where:{name:r.name,categoryId:r.categoryId,storeId:r.storeId}});case 29:if(!(s=e.sent)){e.next=32;break}throw new Error("Category of name ".concat(s.name," already exists."));case 32:return c=r.images.map((function(e){return p(p({},e),{},{storeId:r.storeId})})),e.prev=33,e.next=36,x.create(p(p({},r),{},{images:c}),{include:["images"]}).then((function(e){return e.setStore(o.id),e}));case 36:return u=e.sent,e.abrupt("return",u);case 40:throw e.prev=40,e.t0=e.catch(33),l.log({level:"error",message:"An error occured while creating product for ".concat(a.id," at ").concat((new Date).toLocaleDateString())}),console.log(e.t0),new Error("Could not create a product try again later",e.t0);case 45:case"end":return e.stop()}}),e,null,[[33,40]])})))()},updateProduct:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c,u,d;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.productId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:if(r){e.next=7;break}throw new Error("Product id is required.");case 7:if(a.name){e.next=11;break}throw new Error("A product name is required");case 11:if(a.storeId){e.next=15;break}throw new Error("Store id is required");case 15:if(a.categoryId){e.next=19;break}throw new Error("Category id is required");case 19:if(a.images&&a.images.length){e.next=21;break}throw new Error("Product images is required.");case 21:return e.next=23,S(x,r);case 23:if(o=e.sent){e.next=26;break}throw new Error("Could not find product.");case 26:return e.next=28,E(j,o.storeId,n.merchant.id);case 28:if(s=e.sent){e.next=31;break}throw new Error("Unauthorized operation.");case 31:return e.next=33,R(x,a.name,o.categoryId);case 33:if(!(c=e.sent)){e.next=37;break}if(o.id===c.id){e.next=37;break}throw new Error('Product of name "'.concat(a.name,'" already exists for this store.'));case 37:return e.next=39,_.destroy({where:{productId:r,storeId:a.storeId}});case 39:return e.prev=39,e.next=42,x.update(p(p({},o),a),{where:{id:parseInt(r)}},{include:["images"]});case 42:if(0!==e.sent[0]){e.next=45;break}throw new Error("Update failed");case 45:return e.next=47,S(x,r);case 47:return u=e.sent,e.next=50,a.images.map((function(e){return p(p({},e),{},{storeId:s.id,productId:u.id})}));case 50:return d=e.sent,e.next=53,_.bulkCreate(d);case 53:return e.sent,e.abrupt("return",u);case 57:if(e.prev=57,e.t0=e.catch(39),console.log("[UPDATING PRODUCT ERROR]",e.t0),"not_unique"!==e.t0.validatorKey){e.next=62;break}throw new Error("A category of the given name ".concat(a.name," already exists"));case 62:l.log({level:"error",message:"update store for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 63:case"end":return e.stop()}}),e,null,[[39,57]])})))()},deleteProduct:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.productId,a=t.storeId,n.merchant.id){e.next=3;break}throw new Error("Unauthenticated make sure you are logged in");case 3:if(r){e.next=5;break}throw new Error("Product ID is requreid");case 5:if(a){e.next=7;break}throw new Error("Store ID is required");case 7:return e.next=9,E(j,a,n.merchant.id);case 9:if(o=e.sent){e.next=12;break}throw new Error("Unauthaurized operation");case 12:return e.prev=12,e.next=15,x.destroy({where:{id:r,storeId:o.id}});case 15:e.sent,e.next=22;break;case 18:return e.prev=18,e.t0=e.catch(12),console.log(e.t0),e.abrupt("return",!1);case 22:return e.abrupt("return",!0);case 23:case"end":return e.stop()}}),e,null,[[12,18]])})))()},addProductVariations:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.product,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r.name){e.next=8;break}throw new Error("Product name is required");case 8:if(r.price){e.next=12;break}throw new Error("product price is required");case 12:if(r.categoryId){e.next=16;break}throw new Error("Product's category id is required");case 16:if(r.storeId){e.next=18;break}throw new Error("Product's store id is required");case 18:return e.next=20,E(j,r.storeId,a.id);case 20:if(o=e.sent){e.next=23;break}throw new Error("Unauthorized operation.");case 23:return e.next=25,x.findOne({where:{name:r.name,categoryId:r.categoryId,storeId:r.storeId}});case 25:if(!(s=e.sent)){e.next=28;break}throw new Error("Product of name ".concat(s.name," already exists."));case 28:return e.next=30,x.create(p({},r),{include:[{association:"images"},{model:V,as:"brand"},{association:"prodVariations",include:[{association:"prodVarOptions"}]},{association:"prodCombinations",include:[{association:"variantImage"}]}]}).then((function(e){return e.setStore(o.id),e}));case 30:return c=e.sent,e.abrupt("return",c);case 32:case"end":return e.stop()}}),e)})))()},updateProductVariation:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.productId,a=t.payload,n.merchant){e.next=3;break}throw new Error("Unauthorized make sure you are logged in.");case 3:if(r){e.next=7;break}throw new Error("Product id is required.");case 7:if(a.name){e.next=11;break}throw new Error("A product name is required");case 11:if(a.storeId){e.next=15;break}throw new Error("Store id is required");case 15:if(a.categoryId){e.next=19;break}throw new Error("Category id is required");case 19:if(a.images&&a.images.length){e.next=21;break}throw new Error("Product images is required.");case 21:return e.next=23,S(x,r);case 23:if(o=e.sent){e.next=26;break}throw new Error("Could not find product.");case 26:return e.next=28,E(j,o.storeId,n.merchant.id);case 28:if(e.sent){e.next=31;break}throw new Error("Unauthorized operation.");case 31:return e.next=33,R(x,a.name,o.categoryId);case 33:if(!(s=e.sent)){e.next=37;break}if(o.id===s.id){e.next=37;break}throw new Error('Product of name "'.concat(a.name,'" already exists for this store.'));case 37:return e.next=39,_.destroy({where:{productId:r,storeId:a.storeId}});case 39:return e.prev=39,e.next=42,x.update(p(p({},o),{},{name:a.name,price:a.price,isFeatured:a.isFeatured,isArchived:a.isArchived,categoryId:a.categoryId,storeId:a.storeId,prodVariations:a.prodVariations,prodCombinations:a.prodCombinations}),{where:{id:parseInt(r)}},{include:[{association:"images"},{association:"prodVariations",include:[{association:"prodVarOptions"}]},{association:"prodCombinations",include:[{association:"variantImage"}]}]});case 42:if(0!==e.sent[0]){e.next=45;break}throw new Error("Update failed");case 45:return e.next=47,S(x,r);case 47:return c=e.sent,e.abrupt("return",c);case 51:if(e.prev=51,e.t0=e.catch(39),console.log("[UPDATING PRODUCT ERROR]",e.t0),"not_unique"!==e.t0.validatorKey){e.next=56;break}throw new Error("A category of the given name ".concat(a.name," already exists"));case 56:l.log({level:"error",message:"update store for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 57:case"end":return e.stop()}}),e,null,[[39,51]])})))()},addImage:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.image,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to create a billboard");case 4:return e.next=6,E(j,r.storeId,n.merchant.id);case 6:if(e.sent){e.next=9;break}throw new Error("Unauthorized operation");case 9:return e.prev=9,e.next=12,_.create(p({},r));case 12:return o=e.sent,e.abrupt("return",o);case 16:throw e.prev=16,e.t0=e.catch(9),l.log({level:"error",message:"An error occured while creating image for ".concat(a.id," at ").concat((new Date).toLocaleDateString())}),new Error("Could not create a new image try again later",e.t0);case 20:case"end":return e.stop()}}),e,null,[[9,16]])})))()},deleteImage:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.imageId,a=t.storeId,n.merchant.id){e.next=3;break}throw new Error("Unauthenticated make sure you are logged in");case 3:if(r){e.next=5;break}throw new Error("Image ID is requreid");case 5:if(a){e.next=7;break}throw new Error("Store ID is required");case 7:return e.next=9,E(j,a,n.merchant.id);case 9:if(o=e.sent){e.next=12;break}throw new Error("Unauthaurized operation");case 12:return e.prev=12,e.next=15,_.destroy({where:{id:r,storeId:o.id}});case 15:e.sent,e.next=22;break;case 18:return e.prev=18,e.t0=e.catch(12),console.log(e.t0),e.abrupt("return",!1);case 22:return e.abrupt("return",!0);case 23:case"end":return e.stop()}}),e,null,[[12,18]])})))()},addOrder:function(e,n,r){return c(i.mark((function e(){var r,a,o,s,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.order,a=n.storeId){e.next=3;break}throw new Error("Could not find the store.");case 3:return e.next=5,E(j,a);case 5:if(o=e.sent){e.next=8;break}throw new Error("Unauthorized operation");case 8:if(!r.phone_number){e.next=16;break}return e.next=11,A(t,r.phone_number,o.merchantId);case 11:if(s=e.sent){e.next=16;break}return e.next=15,B(t,{phone_number:r.phone_number},o.merchantId);case 15:s=e.sent;case 16:return e.next=18,se.create(p(p({},r),{},{phone:s.phone_number,customerId:s.id,status:r.isPaid?"CONFIRMED":"PENDING",storeId:a}),{include:[{association:"orderItems",include:{association:"orderProduct"}}]}).then((function(e){var t=o.name.slice(0,10).replaceAll(/[^a-zA-Z0-9]/g,"")+"-".concat(e.id);return se.update(p(p({},e),{},{orderID:t.toLowerCase()}),{where:{id:e.id},returning:!0,include:[{association:"orderItems",include:{association:"orderProduct"}}]}).then((function(t){return se.findOne({where:{id:e.id},include:[{association:"orderItems",include:{association:"orderProduct"}}]})}))}));case 18:return c=e.sent,e.abrupt("return",c);case 20:case"end":return e.stop()}}),e)})))()},updateOrderCheckout:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,u,d;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.storeId,a=t.orderId,o=t.payload,console.log("UPDATING Billboard",a,o,r),a){e.next=4;break}throw new Error("Order id is required");case 4:if(r){e.next=6;break}throw new Error("Unauthorized operation");case 6:return e.next=8,E(j,r);case 8:if(s=e.sent){e.next=11;break}throw new Error("Unauthorized operation");case 11:return e.next=13,se.findOne({where:{id:a,storeId:s.id}});case 13:if(u=e.sent){e.next=16;break}throw new Error("Could not find the order");case 16:return e.prev=16,e.next=19,se.update(p(p({},u),{},{isPaid:o.isPaid,address:o.address,phone:o.phone_number,status:o.isPaid?"CONFIRMED":"PENDING"}),{where:{id:parseInt(u.id),storeId:r},returning:!0,plain:!0},{include:["orderItems"]}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,se.findOne({where:{id:t[1].id},include:[{association:"customerOrder"},{association:"orderItems",include:{association:"orderProduct"}}]});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 19:return d=e.sent,console.log(d),e.abrupt("return",d);case 24:e.prev=24,e.t0=e.catch(16),l.log({level:"error",message:"update orderItesm for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleDateString())});case 27:case"end":return e.stop()}}),e,null,[[16,24]])})))()},signupMerchant:function(e,t,r){return c(i.mark((function e(){var a,s,u,d;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.username,s=t.password,u=t.whatsapp_phone_number,d=t.email,e.abrupt("return",n.findAll({where:o({},I.or,[{whatsapp_phone_number:u},{username:a}]),raw:!0}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.length){e.next=4;break}throw new Error("Username or phone number already in use");case 4:return e.abrupt("return",h.hash(s,10).then((function(e){return n.create({username:a,password:e,email:d,whatsapp_phone_number:u,activated:1}).then((function(e){var t=f.sign({username:a,id:e.id},K,{expiresIn:"1d"});return v(r,t),{token:t,merchant:e}}))})));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e)})))()},loginMerchant:function(e,t,r){return c(i.mark((function e(){var a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.username,o=t.password,e.abrupt("return",n.findAll({where:{username:a},raw:!0}).then(function(){var e=c(i.mark((function e(t){var n,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1!==t.length){e.next=12;break}return n=t[0],e.next=4,h.compare(o,n.password);case 4:if(e.sent){e.next=7;break}throw new Error("Password or username does not match");case 7:return s=f.sign({username:a,id:n.id},K,{expiresIn:"1d"}),v(r,s),e.abrupt("return",{token:s,merchant:n});case 12:throw new Error("Error while logging you in we did not find the user");case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}}),e)})))()},logoutMerchant:function(e,t,n){return v(n,logout=!0),{message:!0}},addBulkTemplateTask:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.schedule,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated please make sure you are logged in.");case 4:if(r){e.next=6;break}throw new Error("An error occured. Could not add the schedule");case 6:return e.next=8,pe.create(p(p({},r),{},{merchantId:a.id,timestamp:new Date(r.timestamp).getUTCDate(),bulkTempTask:r.bulkTempTask}),{include:{association:"bulkTempTask"}});case 8:return o=e.sent,console.log(o),e.abrupt("return",o);case 11:case"end":return e.stop()}}),e)})))()},updateBulkTemplateTask:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.taskId,a=t.merchantId,n.merchant){e.next=4;break}throw new Error("No authentication headers");case 4:return a||l.log({level:"error",message:"##################Could not find the merchant's ID while updating task##########"}),e.next=7,pe.findOne({where:{id:r,merchantId:a}});case 7:return o=e.sent,e.prev=8,e.next=11,pe.update(p(p({},o),{},{status:"EXECUTED"}),{where:{id:r,merchantId:a}});case 11:return e.abrupt("return","success");case 14:throw e.prev=14,e.t0=e.catch(8),l.log({level:"error",message:"Could not update {}"}),console.log(e.t0),new Error("Could not update Schedule task for ID ".concat(r));case 19:case"end":return e.stop()}}),e,null,[[8,14]])})))()},addDiscount:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.discount,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r.name){e.next=8;break}throw new Error("Discount name is required");case 8:if(r.startDate){e.next=12;break}throw new Error("Discount's start date is required");case 12:if(r.endDate){e.next=16;break}throw new Error("Discount's end date id is required");case 16:if(r.discountType){e.next=20;break}throw new Error("Discount's type is required");case 20:if(r.discountValue){e.next=24;break}throw new Error("Discount value is required.");case 24:if(r.storeId){e.next=26;break}throw new Error("Discount Store is required.");case 26:return e.next=28,E(j,r.storeId,a.id);case 28:if(e.sent){e.next=31;break}throw new Error("Unauthorized operation.");case 31:return e.prev=31,e.next=34,le.create(p({},r));case 34:return o=e.sent,e.abrupt("return",o);case 38:throw e.prev=38,e.t0=e.catch(31),console.log(e.t0),l.log({level:"error",message:"An error occured while creating a discount promotion for ".concat(a.id," at ").concat((new Date).toTimeString())}),new Error("Could not create a discount promotion.",e.t0);case 43:case"end":return e.stop()}}),e,null,[[31,38]])})))()},updateDiscount:function(e,t,n){return c(i.mark((function e(){var r,a,o,s,u;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.promotionId,a=t.payload,n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(a.name){e.next=8;break}throw new Error("Discount name is required");case 8:if(a.startDate){e.next=12;break}throw new Error("Discount's start date is required");case 12:if(a.endDate){e.next=16;break}throw new Error("Discount's end date id is required");case 16:if(a.discountType){e.next=20;break}throw new Error("Discount's type is required");case 20:if(a.discountValue){e.next=24;break}throw new Error("Discount value is required.");case 24:if(a.storeId){e.next=26;break}throw new Error("Discount Store is required.");case 26:return e.next=28,le.findOne({where:{id:r}});case 28:if(o=e.sent){e.next=31;break}throw new Error("Could not find promotion discount.");case 31:return e.next=33,E(j,o.storeId,n.merchant.id);case 33:if(s=e.sent){e.next=36;break}throw new Error("Unauthorized operation.");case 36:return e.prev=36,e.next=39,le.update(p(p({},o),{},{name:a.name,startDate:a.startDate,endDate:a.endDate,active:a.active,discountType:a.discountType,discountValue:a.discountValue,description:a.description}),{where:{id:parseInt(r),storeId:s.id},returning:!0,plain:!0}).then(function(){var e=c(i.mark((function e(t){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t[1]);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 39:return u=e.sent,e.abrupt("return",u);case 43:e.prev=43,e.t0=e.catch(36),console.log("[UPDATING DISCOUNT ERROR]",e.t0),l.log({level:"error",message:"update promotin discount for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleTimeString())});case 47:case"end":return e.stop()}}),e,null,[[36,43]])})))()},deleteDiscount:function(e,t,n){return c(i.mark((function e(){var r,a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.promotionId,a=t.storeId,n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r){e.next=8;break}throw new Error("Could not delete promotion");case 8:if(a){e.next=10;break}throw new Error("Discount Store is required.");case 10:return e.next=12,le.findOne({where:{id:r,name:"discount"}});case 12:if(o=e.sent){e.next=15;break}throw new Error("Could not find promotion discount.");case 15:return e.next=17,E(j,o.storeId,n.merchant.id);case 17:if(s=e.sent){e.next=20;break}throw new Error("Unauthorized operation.");case 20:return e.prev=20,e.next=23,le.destroy({where:{id:r,storeId:s.id}});case 23:e.sent,e.next=31;break;case 26:return e.prev=26,e.t0=e.catch(20),console.log(e.t0),l.log({level:"error",message:"delete promotion discount for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleTimeString())}),e.abrupt("return","failed");case 31:return e.abrupt("return","success");case 32:case"end":return e.stop()}}),e,null,[[20,26]])})))()},addCoupon:function(e,t,n){return c(i.mark((function e(){var r,a,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.promotion,a=n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r.name){e.next=8;break}throw new Error("Discount name is required");case 8:if(r.coupon.validFrom){e.next=12;break}throw new Error("Discount's start date is required");case 12:if(r.coupon.validTo){e.next=16;break}throw new Error("Discount's end date id is required");case 16:if(r.coupon.discount){e.next=20;break}throw new Error("Discount value is required.");case 20:if(r.storeId){e.next=22;break}throw new Error("Discount Store is required.");case 22:return e.next=24,E(j,r.storeId,a.id);case 24:if(e.sent){e.next=27;break}throw new Error("Unauthorized operation.");case 27:return e.prev=27,e.next=30,le.create(p({},r),{include:["coupon"]});case 30:return o=e.sent,e.abrupt("return",o);case 34:throw e.prev=34,e.t0=e.catch(27),console.log(e.t0),l.log({level:"error",message:"An error occured while creating a coupon promotion for ".concat(a.id," at ").concat((new Date).toTimeString())}),new Error("Could not create a coupon promotion.",e.t0);case 39:case"end":return e.stop()}}),e,null,[[27,34]])})))()},updateCoupon:function(e,t,n){return c(i.mark((function e(){var a,o,s,d,m;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.promotionId,o=t.payload,n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(o.name){e.next=8;break}throw new Error("Discount name is required");case 8:if(o.coupon.validFrom){e.next=12;break}throw new Error("Discount's start date is required");case 12:if(o.coupon.validTo){e.next=16;break}throw new Error("Discount's end date id is required");case 16:if(o.coupon.discount){e.next=20;break}throw new Error("Discount value is required.");case 20:if(o.storeId){e.next=22;break}throw new Error("Discount Store is required.");case 22:return e.next=24,le.findOne({where:{id:a}});case 24:if(s=e.sent){e.next=27;break}throw new Error("Could not find coupon promotion.");case 27:return e.next=29,E(j,s.storeId,n.merchant.id);case 29:if(d=e.sent){e.next=32;break}throw new Error("Unauthorized operation.");case 32:return e.prev=32,e.next=35,le.update(p(p({},s),{},{name:o.name,discountType:o.discountType,description:o.description,coupon:o.coupon}),{where:{id:parseInt(a),storeId:d.id},returning:!0,plain:!0,include:{association:"coupon"}}).then(function(){var e=c(i.mark((function e(t){var n,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("the promotion",s),(n=o.coupon).id,c=r(n,u),e.next=4,me.update(p({},c),{where:{id:o.coupon.id}});case 4:return e.sent,e.abrupt("return",le.findOne({where:{id:a},include:["coupon"]}));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 35:return m=e.sent,e.abrupt("return",m);case 39:e.prev=39,e.t0=e.catch(32),console.log("[UPDATING DISCOUNT ERROR]",e.t0),l.log({level:"error",message:"update promotin discount for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleTimeString())});case 43:case"end":return e.stop()}}),e,null,[[32,39]])})))()},deleteCoupon:function(e,t,n){return c(i.mark((function e(){var r,a,o,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.promotionId,a=t.storeId,n.merchant){e.next=4;break}throw new Error("Unauthenticated make sure you are logged in to add a category");case 4:if(r){e.next=8;break}throw new Error("Could not delete promotion");case 8:if(a){e.next=10;break}throw new Error("Coupon Store is required.");case 10:return e.next=12,le.findOne({where:{id:r,name:"coupon"}});case 12:if(o=e.sent){e.next=15;break}throw new Error("Could not find coupon promotion.");case 15:return e.next=17,E(j,o.storeId,n.merchant.id);case 17:if(s=e.sent){e.next=20;break}throw new Error("Unauthorized operation.");case 20:return e.prev=20,e.next=23,le.destroy({where:{id:r,storeId:s.id}});case 23:e.sent,e.next=31;break;case 26:return e.prev=26,e.t0=e.catch(20),console.log(e.t0),l.log({level:"error",message:"delete promotion coupon for ".concat(n.merchant.id," failed ").concat((new Date).toLocaleTimeString())}),e.abrupt("return","failed");case 31:return e.abrupt("return","success");case 32:case"end":return e.stop()}}),e,null,[[20,26]])})))()}},RootSubscription:{messageAdded:{subscribe:b((function(){return $.asyncIterator(["messageAdded"])}),function(){var e=c(i.mark((function e(t,n){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.messageAdded.message.chatId===n.chatId);case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())},chatAdded:{subscribe:b((function(){return $.asyncIterator(["chatAdded"])}),function(){var e=c(i.mark((function e(t,n){return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.chatAdded.merchantId===n.merchantId);case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())}}};return ge}},6854:(e,t,n)=>{var r=n(3338);r.Date,r.Decimal,e.exports=["#graqhql\n    scalar Date\n    scalar Decimal\n    # tell apollo server @auth can be used with queries, fields, and field definitions so that use it everywhere\n    directive @auth on QUERY | FIELD_DEFINITION | FIELD\n\n    type Merchant {\n        id: Int\n        business_name: String\n        username: String!\n        password: String\n        email: String\n        whatsapp_phone_number: String\n        customers: [Customer]\n        setting: Setting\n        products: [Product]\n        chats: [Chat]\n        stores: [Store]\n    }\n    type Customer {\n        id: Int!\n        whatsapp_name: String\n        phone_number: String!\n        first_name: String\n        last_name: String\n        age: Int\n        gender: String\n        incomeCategory: String\n        customerSegment: String\n        occupation: String\n        joinDate: Date\n        lastPromoted: Date\n        status: String\n\n        createdAt: Date\n\n        customerLoyalty: Loyalty\n        merchant: Merchant\n        customerOrder: [Order]\n    }\n    \n    type Chat {\n        id: Int!\n        createdAt: Date\n        merchant: Merchant!\n        customer: Customer!\n        messages: [Message]!\n        lastMessage: Message\n        conversations:[Conversation]\n        status: String\n    }\n\n    type Conversation {\n        id: Int!\n        chat: Chat\n\n        conversationId:String\n        status: String\n        pricingModel: String\n        category: String\n        expiryDate: Date\n    }\n    type Message {\n        id: Int!\n        chat: Chat\n        type: String\n        isAd: Boolean\n        text: TextMessage\n        image: ImageMessage\n        video: VideoMessage\n        document: DocumentMessage\n        interactive: InteractiveMessage\n        mesBtnReply: ButtonRepliedAction\n        mesListReply: ListRepliedAction\n        mesTempReply: TemplateRepliedAction\n        messageAd: Ad\n        hasContext: Boolean\n        context: Message\n        contexts: [Message]\n        from_customer: Boolean\n        messageId: String\n        status: String\n        timestamp: Date\n        createdAt: Date\n    }\n    type TextMessage {\n        id: Int\n        body: String!\n    }\n    type ImageMessage{\n        id: Int!\n        imageId: String\n        caption: String\n        mimeType: String\n        sha256: String\n        url: String\n        AWfileId: String\n        AWbucketId: String\n        message: Message!\n    }\n    type VideoMessage{\n        id: Int!\n        videoId: String\n        caption: String\n        mimeType: String\n        sha256: String\n        url: String\n        message: Message!\n    }\n    type DocumentMessage{\n        id: Int!\n        documentId: String\n        caption: String\n        mimeType: String\n        sha256: String\n        filename: String\n        url: String\n        message: Message!\n    }\n    type InteractiveMessage {\n        id: Int!\n        message: Message!\n        type: String!\n        button: InteractiveButton\n        list: InteractiveList\n        template: InteractiveTemplate\n    }\n####################### INTERACTIVE BUTTON ############################################\n\n    type InteractiveButton {\n        id: Int!\n        interactiveMessage: InteractiveMessage!\n        header: String\n        btnImageHead: ImageHeader\n        btnTextHead: TextHeader\n        body: String\n        footer: String\n        action: String  # action you want the user to take\n        buttons: [ButtonReplyAction] # the actions the user can take\n        product: Product\n    }\n    type ButtonReplyAction {\n        id: Int!\n        button: InteractiveButton!\n        buttonId: String!\n        title: String!\n    }\n    type ButtonRepliedAction {\n        id: Int\n        buttonId: String\n        title: String\n\n        message: Message\n        buttonReply: InteractiveButton\n    }\n######################################INTERACTIVE LIST #################################\n    type InteractiveList {\n        id: Int!\n        header: String\n        body: String\n        footer: String\n        button: String # action you want the user to take a button to open the list to make order\n        \n        interactiveMessage: InteractiveMessage!\n        sections: [ListSection]\n        listReplys: ListRepliedAction\n        listTextHead: TextHeader\n    }\n    type ListSection {\n        title: String\n\n        interactiveList: InteractiveList!\n        rows: [ListRowButton]\n    }\n    type ListRowButton {\n        id: Int!\n        buttonId: String\n        title: String\n        description: String\n        \n        listSection: ListSection\n        product: Product\n    }\n    \n    type ListRepliedAction {\n        id: Int\n        buttonId: String\n        title: String\n        description: String\n\n        message: Message\n        listReply: ListRowButton\n    }\n\n###################################INTERACTIVE TEMPLATE##################################\n    type InteractiveTemplate {\n        id: Int!\n        header: String\n        body: String\n        footer: String\n        action: String  # action you want the user to take\n        \n        buttons: [TemplateReplyAction] # the actions the user can take\n        interactiveMessage: InteractiveMessage!\n        tempProduct: Product\n        tempImageHead: ImageHeader\n        tempTextHead: TextHeader\n    }\n    type TemplateReplyAction {\n        id: Int!\n        template: InteractiveTemplate!\n        text: String!\n    }\n    type TemplateRepliedAction {\n        id: Int\n        text: String\n        payload: String\n\n        message: Message\n        tempReply: InteractiveTemplate\n    }\n\n####################################################MESSAGE HEADERS##############################\n\n    type ImageHeader {\n        link: String!\n    }\n    type TextHeader {\n        body: String\n    }\n    type DocumentHeader {\n        link: String\n        mimeType: String\n        filename: String\n    }\n    type VideoHeader {\n        link: String\n    }\n\n    type MessageFeed {\n        cursor: String! # The place in the list where we left off\n        messages: [Message]! # A chunk\n    }\n    type Setting {\n        callBack_url: String!\n        app_id:String!\n        app_secret:String!\n        phone_number_id:String!\n        business_account_id:String!\n        access_token:String!\n        api_version:String!\n        webhook_verification_token:String!\n        phone_number:String\n    }\n\n    ###########################  STORE SCHEMA #############################\n    type Store {\n        id:  Int!\n        name: String!\n        merchant: Merchant\n        billboards: [Billboard]\n        products: [Product]\n        mpesa: MpesaSetting\n        createdAt: Date!\n        updatedAt: Date!\n    }\n    type Brand {\n        id: Int!\n        name: String!\n        joinDate: Date\n        description: String!\n        phoneNumber: String!\n        industry: String!\n        loc_name: String!\n        loc_address: String!\n        loc_latitude: String\n        loc_longitude: String\n        loc_url: String\n        storeId: Int\n    }\n    type Billboard {\n        id: Int!\n        label: String!\n        imageUrl: String\n        store: Store\n        categories: [Category]\n        createdAt: Date!\n        updatedAt: Date!\n    }\n    type Category {\n        id: Int!\n        name: String!\n        store: Store!\n        products: [Product]\n        billboard: Billboard!\n        updatedAt: Date!\n    }\n\n    ###########################  PRODUCT SCHEMA #############################\n    type Product{\n        id: Int!\n        name: String!\n        price: Decimal!\n        isFeatured: Boolean\n        isArchived: Boolean\n        category: Category!\n        store: Store!\n        description: String\n        brand: Brand\n        stockCode: String\n        images: [Image]!\n\n        prodVariations: [ProductVariation]\n        prodCombinations: [ProductCombination]\n\n        updatedAt: Date\n    }\n    type ProductVariation {\n        name: String\n\n        prodVariation: Product\n        prodVarOptions: [ProductVariationOption]\n    }\n    type ProductVariationOption {\n        value: String\n        prodVarOption: ProductVariation\n    }\n    type ProductCombination {\n        price: Decimal,\n        sku: String,\n        availableStock: Int\n        combinationString: String\n        variantImage: ProductImage\n        productVariants: [ProductVariationOption]\n\n        prodCombination: Product,\n    }\n    \n    type ProductImage {\n        link: String\n    }\n\n    type Image {\n        id: Int!\n        url: String!\n        productId: Int!\n        storeId: Int!\n    }\n\n    ###########################  ORDERS SCHEMA #############################\n    type Order {\n        id: Int!\n        orderID: String\n        isPaid: Boolean!\n        phone: String!\n        status: String!\n        address: String!\n        storeOrder: Store\n        customerOrder: Customer\n        orderItems: [OrderItem]!\n        createdAt: Date\n        updatedAt: Date\n    }\n    type OrderItem {\n        id: Int!\n        price: Decimal!\n        quantity: Int!\n        productId: Int\n        order: Order\n        orderProduct: Product!\n    }\n\n    type CusChatSearch {\n        chats: [Chat]\n        customers: [Customer]\n    }\n    type ReturnedChat {\n        messages: [Message]\n        customer: Customer\n        conversations: [Conversation]\n    }\n\n    ###################### Marketing ####################################\n    type Ad {\n        id: Int!\n        merchantId: Int!\n        adTemplate: AdTemplate!\n        read: Int\n        delivered: Int\n        sent: Int\n        failed: Int\n        response: Int\n        updatedAt: Date\n    }\n    type AdTemplate {\n        id: Int!\n        name: String!\n        leads: Int\n        merchant: Merchant!\n        adTempProduct: Product\n        adTempMessage: Message\n        adTempResponses: [MarketingResponse]\n    }\n    type MarketingResponse {\n        id: Int!\n        cusTempLead: Customer\n        mesTempLead: Message\n        # prodTempLead: Product\n        # adTempLead: AdTemplate\n    }\n\n    ##################Task scheduling#####################\n\n    type ScheduleTask {\n        id: Int\n        merchantsTasks: Merchant\n        type: String\n        timestamp: Date\n        bulkTempTask: BulkTemplateTask\n    }\n\n    type BulkTemplateTask {\n        id: Int\n        schedule: ScheduleTask\n        message: String\n        template: String\n        customers: String\n    }\n\n    ##################### PROMOTION SCHEMA ###################################\n    #################### Loyalty Program #################\n    type Purchase {\n        id: Int\n        totalAmount: Decimal\n        pointsEarned: Int\n        purchaseDate: Date\n        createdAt: Date\n        updatedAt: Date\n\n        customer: Customer\n    }\n\n    type Loyalty {\n        id: Int\n        pointsBalance: Int\n        lastUpdated: Date\n        createdAt: Date\n        updatedAt: Date\n\n        customer: Customer\n    }\n\n    type Reward {\n        id: Int\n        rewardName: String\n        pointsRequired: Int\n        description: String\n        createdAt: Date\n        updatedAt: Date\n    }\n\n    type Redemption {\n        id: Int\n        redemptionDate: Date\n        pointsUsed: Int\n        createdAt: Date\n        updatedAt: Date\n        \n        reward: Reward\n        customer: Customer\n    }\n\n    ################ PROMOTION #################\n    enum PromotionType {\n        coupon\n        free_gifts\n        discount\n        free_shipping\n        upsell_special\n        member_referral\n        free_trial\n        give_away\n        bogo\n        loyalty\n        bundle\n        tiered_discount\n        subscription\n        flash_sale\n        competition\n        donation\n        cash_back\n    }\n\n    enum DiscountType {\n        percent\n        fixed\n    }\n\n    type Promotion {\n        id: Int\n        name: PromotionType!\n        startDate: Date\n        endDate: Date\n        description: String\n        discountType: DiscountType\n        active: Boolean\n        discountValue: Decimal\n        createdAt: Date\n        updatedAt: Date\n\n        coupon: Coupon\n        store: Store\n    }\n\n    type PromotionProduct {\n        id: Int\n        createdAt: Date\n        updatedAt: Date\n\n        promotionProducts: [Promotion]\n        productPromotions: [Product]\n    }\n\n    type PromotionCustomer {\n        id: Int\n        redemptionDate: Date\n        reedemed: Boolean\n        createdAt: Date,\n        updatedAt: Date\n\n        customerPromotions: [Customer]\n        product: [Product]\n    }\n\n    type Sale {\n        id: Int\n        saleDate: Date\n        totalAmount: Decimal\n        createdAt: Date\n        updatedAt: Date\n\n        customerSales: Customer\n        salePromotions: Promotion\n        saleDetails: [SaleDetail]\n    }\n\n    type SaleDetail {\n        unitPrice: Decimal,\n        discount: Decimal,\n        quantity: Int\n        \n        sales: Sale,\n        product: Product,\n    }\n\n\n    ################## TYPES OF PROMOTIONS ##################\n    type Coupon {\n        id: Int\n        code: String\n        validFrom: Date\n        validTo: Date\n        discount: Decimal\n        active: Boolean\n        createdAt: Date\n        updatedAt: Date\n    }\n\n    ################## TYPE PAYMENT ###############\n    type MpesaSetting {\n        id: Int\n        consumer_key: String!\n        consumer_secret: String!\n        pass_key: String!\n        business_shortcode: String!\n        account_reference: String!\n        transaction_desc: String!\n        store: Store\n        callback_url: String\n    }\n\n    ##########################################################################\n    type RootQuery {\n        customers: [Customer] @auth\n        customer(customerId: Int!): Customer\n        customer360(customerId: Int!): Customer\n        chats: [Chat] @auth\n        chat(chatId: Int!): ReturnedChat @auth\n        lastMessage(chatId: Int!): Message @auth\n        setting(username: String): Setting\n        allProducts: [Store] @auth\n        productSearch(page: Int, limit: Int, text: String!, storeId: Int!): [Product] @auth\n        customerSearch(page: Int, limit: Int, text: String!): [Customer] @auth\n        \n        stores: [Store] @auth\n        store(storeId: Int):Store @auth\n        mpesa(storeId: Int!): MpesaSetting\n        brand(brandId: Int!): Brand @auth\n        brands(storeId: Int!): [Brand] @auth\n        billboards(storeId: Int): [Billboard]\n        billboard( billboardId: Int!):Billboard! \n        categories(storeId: Int!): [Category]\n        category(categoryId: Int!): Category!\n        products(storeId: Int!, categoryId: Int): [Product]\n        productsIds( storeId: Int,productIds: [Int]): [Product]!\n        productsWithVariants(storeId: Int!, categoryId: Int, variantId: Int): [Product]\n        product(productId: Int!): Product!\n        orders(storeId: Int!): [Order]!\n        currentMerchant: Merchant @auth\n        customersSearch(page: Int, limit: Int, text: String!): [Customer] @auth\n        customerChatSearch(page: Int, limit: Int, text: String!): CusChatSearch @auth\n        ads: [Ad] @auth\n        tempMarketResponse(adTemplateId: Int!): AdTemplate @auth\n        templateSchedules: [ScheduleTask]\n\n\n        ################ PROMOTION ########\n        promotions(storeId: Int!): [Promotion] @auth\n        sales(storeId: Int!): [Sale] \n    }\n\n\n\n    input ChatInput {\n        merchant: Int\n        customer: Int!\n    }\n    input ChatStatus {\n        messageId: String\n        status: String\n    }\n\n    input MessageInput{\n        chatId: Int\n        messageId: String\n        status: String\n        from_customer: Boolean!\n        timestamp: Date!\n        type: String!\n    }\n\n    input ContextMessageInput {\n        messageId: String!\n    }\n\n    input TextInput{\n        body: String!\n    }\n    input TextMessageInput{\n        message: MessageInput!\n        text: TextInput!\n    }\n\n    input ImageInput {\n        caption: String\n        mimeType: String\n        sha256: String\n        imageId: String\n\n        url: String\n        AWfileId: String\n        AWbucketId: String\n    }\n    input ImageMessageInput{\n        message: MessageInput!\n        image: ImageInput\n    }\n\n    input DocumentInput {\n        caption: String\n        mimeType: String\n        sha256: String\n        filename: String\n        documentId: String\n        url: String\n    }\n    input DocumentMessageInput{\n        message: MessageInput!\n        document: DocumentInput\n    }\n\n    input VideoInput {\n        caption: String\n        mimeType: String\n        sha256: String\n        videoId: String\n\n        url: String\n    }\n    input VideoMessageInput{\n        message: MessageInput!\n        video: VideoInput\n    }\n##############################MESSAGE HEADER INPUTS##########################33\n    input ImageHeaderInput {\n        link: String!\n    }\n    input VideoHeaderInput {\n        link: String!\n    }\n    input TextHeaderInput {\n        body: String!\n    }\n    input DocumentHeaderInput {\n        link: String!\n        filename: String\n        mimeType: String\n    }\n###################################### BUTTON ###########################\n    input ButtonReplyActionInput {\n        buttonId: String!\n        title: String!\n    }\n    input InteractiveButtonInput {\n        header: String\n        btnImageHead: ImageHeaderInput\n        btnTextHead: TextHeaderInput\n        body: String\n        footer: String\n        action: String\n        productId: Int\n        buttons: [ButtonReplyActionInput]\n    }\n#################################LIST INPUT##########################\n    input ListRowButtonInput {\n        buttonId: String!\n        title: String!\n        description: String!\n        productId: Int\n        interactiveListId: Int\n    }\n    input ListSectionInput {\n        title: String\n        rows: [ListRowButtonInput]\n    }\n    input InteractiveListInput {\n        header: String\n        listTextHead: TextHeaderInput\n        body: String\n        footer: String\n        button: String\n        sections: [ListSectionInput]\n    }\n########################TEMPLATE INPUT################################################\n    input TemplateReplyActionInput {\n        text: String!\n    }\n    input InteractiveTemplateInput {\n        header: String\n        tempTextHead: TextHeaderInput\n        tempImageHead: ImageHeaderInput\n        body: String\n        footer: String\n        action: String\n        productId: Int\n        buttons: [TemplateReplyActionInput]\n    }\n    input InteractiveInput {\n        type: String!\n        button: InteractiveButtonInput\n        list: InteractiveListInput\n        template: InteractiveTemplateInput\n    }\n    input InteractiveMessageInput {\n        message: MessageInput!\n        interactive: InteractiveInput\n    }\n     ############Reply to template message###########\n    input TemplateRepliedActionInput {\n        text: String!\n        payload: String\n        \n        messageId: Int\n        interactiveTemplateId: Int \n    }\n\n    input TemplateRepliedInput {\n        message: MessageInput!\n        mesTempReply: TemplateRepliedActionInput\n    }\n \n############################################################3\n    input ButtonRepliedActionInput {\n        buttonId: String!\n        title: String!\n        \n        messageId: Int\n        interactiveButtonId: Int \n    }\n    input ButtonRepliedInput {\n        message: MessageInput!\n        mesBtnReply: ButtonRepliedActionInput\n    }\n################################################\n    input ListRepliedInput {\n        message: MessageInput!\n        mesListReply: ListRepliedActionInput\n    }\n    input ListRepliedActionInput {\n        buttonId: String!\n        title: String!\n        description: String!\n        messageId: Int\n        listRowButtonId: Int \n    }\n\n#####################################\n\n    input ParticipantsInput{\n        mer_username: String!\n        customer: CustomerInput!\n    }\n\n    input SettingInput {\n        callBack_url: String\n        app_id:String\n        app_secret:String\n        phone_number_id:String\n        business_account_id:String\n        access_token:String\n        api_version:String\n        webhook_verification_token:String\n        phone_number:String\n    }\n    input MerchantInput {\n        business_name: String!\n        username: String!\n        password: String!\n        email: String\n        whatsapp_phone_number: String\n    }\n    type ReqNotification{\n        notification: String!\n    }\n    type Auth {\n        token: String\n        merchant: Merchant\n    }\n\n    type Response {\n        response: String\n    }\n\n    input StoreInput{\n        name: String!\n    }\n    input BrandInput {\n        name: String!\n        joinDate: Date!\n        description: String!\n        phoneNumber: String\n        industry: String!\n        loc_name: String!\n        loc_address: String!\n        loc_latitude: String\n        loc_longitude: String\n        loc_url: String\n        storeId: Int\n    }\n\n    input BillboardInput {\n        label: String\n        imageUrl: String\n        storeId: Int!\n    }\n    input CategoryInput {\n        name: String!\n        billboardId: Int!\n    }\n    ################################## ADD A PRODUCT  #############\n    input ProductInput{\n        name: String!\n        price: Decimal!\n        description: String\n        stockCode: String\n        brand: String\n        images: [ImageInput]\n        isFeatured: Boolean\n        isArchived: Boolean\n        categoryId: Int!\n        brandId: Int!\n        storeId: Int!\n\n        prodVariations: [ProductVariationInput]\n        prodCombinations: [ProductCombInput]\n    }\n    input ProductVariationInput {\n        name: String,\n        prodVarOptions: [ProductVarOptionInput]\n    }\n    input ProductVarOptionInput {\n        value: String\n    }\n    input ProductCombInput {\n        price: Decimal\n        sku: String\n        availableStock: Int\n        combinationString: String\n        variantImage: ProductImageInput\n        productVariants: [ProductVariationInput]\n    }\n\n    input ProductImageInput {\n        link: String!\n        storeId: Int!\n    }\n\n    input ImageInput {\n        url: String!\n        storeId: Int\n        productId: Int\n    }\n\n\n    input OrderInput {\n        customerId: Int\n        isPaid: Boolean\n        phone_number: String!\n        address: String\n\n        orderItems: [OrderItemInput]\n    }\n    input OrderCheckoutInput {\n        isPaid: Boolean\n        phone_number: String!\n        address: String!\n    }\n    input OrderItemInput {\n        productId: Int!\n        price: Decimal!\n        quantity: Int!\n    }\n\n    ###################### Scheduling task #####################\n    input ScheduleTaskInput {\n        type: String!\n        status: String!\n        timestamp: Date!\n        bulkTempTask: TemplateTaskInput\n    }\n    input TemplateTaskInput {\n        message: String\n        template: String\n        customers: String\n    }\n\n    ###################### SALES PROMOTION ######################\n    input CouponInput {\n        id: Int\n        code: String!\n        validFrom: Date!\n        validTo: Date!\n        discount: Decimal!\n        active: Boolean\n    }\n\n    input CouponPromInput {\n        name: String!\n        storeId: Int!\n        description: String\n        discountType: DiscountType!\n        discountValue: Decimal\n        \n        coupon: CouponInput!\n    }\n\n    input DiscountPromInput {\n        storeId: Int!\n        name: PromotionType!\n        startDate: Date!\n        endDate: Date!\n        description: String\n        discountType: DiscountType!\n        discountValue: Decimal!\n        active: Boolean!\n    }\n\n    ################### LOYALTY PROGRAM ######################\n    \n    \n    input LoyaltyInput {\n        customerId: Int\n        pointsBalance: Int\n        lastUpdated: Date\n    }\n\n    input RewardInput {\n        rewardName: String\n        pointsRequired: Int\n        description: String\n    }\n\n    input RedemptionInput {\n        customerId: Int\n        rewardId: Int\n        pointsUsed: Int\n        redemptionDate: Date\n    }\n\n    ################# Customer #########################\n    enum GenderType {\n        male\n        female\n        not_sure\n    }\n    enum IncomeCategoryType {\n        high\n        low\n        medium\n    }\n    enum CustomerSegmentType {\n        cooperate\n        small\n        medium\n        individual\n    }\n    enum OccupationType {\n        student\n        employed\n        self_employed\n    }\n\n    enum CustomerStatus {\n        high_rated\n        low_rated\n        new\n        medium_rated\n    }\n    input CustomerInput {\n        whatsapp_name: String\n        phone_number: String!\n        first_name: String\n        last_name: String\n        merchantId: Int\n        age: Int\n        gender: GenderType\n        incomeCategory: IncomeCategoryType\n        customerSegment: CustomerSegmentType\n        occupation: OccupationType\n        joinDate: Date\n        lastPromoted: Date\n        status: CustomerStatus\n\n        customerLoyalty: LoyaltyInput\n    }\n\n    input MpesaSettingInput {\n        consumer_key: String\n        consumer_secret: String\n        pass_key: String\n        business_shortcode: String\n        account_reference: String\n        transaction_desc: String\n        callback_url: String\n        storeId: Int\n    }\n  \n\n    type RootMutation {\n        addCustomer (\n            customer: CustomerInput!\n        ): Customer @auth\n        addChat (\n            chat: ChatInput!\n        ): Chat\n        addTextMessage (\n            message: TextMessageInput!\n            template: String,\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addTemplateMesBulk (\n            message: InteractiveMessageInput!\n            selectedCustomers: String!\n            template: String\n        ): Message\n        addImageMessage (\n            message: ImageMessageInput!\n            template: String\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addDocumentMessage (\n            message: DocumentMessageInput!\n            template: String\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addVideoMessage (\n            message: VideoMessageInput!\n            template: String\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addInteractiveButtonMessage (\n            message: InteractiveMessageInput!\n            template: String\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addInteractiveTemplateMessage (\n            message: InteractiveMessageInput,\n            template: String\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addInteractiveListMessage (\n            message: InteractiveMessageInput!\n            template: String\n            participants: ParticipantsInput\n            customerId: Int\n            contextMessage: ContextMessageInput\n        ): Message\n        addButtonRepliedMessage (\n            message: ButtonRepliedInput!\n            participants: ParticipantsInput\n            contextMessage: ContextMessageInput\n        ): Message\n        addTemplateRepliedMessage (\n            message: TemplateRepliedInput!\n            participants: ParticipantsInput\n            contextMessage: ContextMessageInput\n        ): Message\n        addListRepliedMessage (\n            message: ListRepliedInput!\n            participants: ParticipantsInput\n            contextMessage: ContextMessageInput\n        ): Message\n        addSetting (\n            setting: SettingInput!\n        ): Setting @auth\n        addStore (\n            store: StoreInput!\n        ): Store @auth\n        addBrand (\n            brand: BrandInput!\n        ): Brand @auth\n        addBillboard (\n            billboard: BillboardInput!\n        ): Billboard @auth\n        addCategory (\n            category: CategoryInput!\n        ): Category @ auth\n        addMpesa (\n            mpesa: MpesaSettingInput\n        ): MpesaSetting @auth\n\n\n        addProduct (\n            product: ProductInput!\n        ): Product @auth\n        addProductVariations (\n            product: ProductInput\n        ): Product @auth\n\n        addImage (\n            image: ImageInput!\n        ): Image @auth\n        addOrder(\n            order: OrderInput!\n            storeId: Int!\n        ): Order\n        addBulkTemplateTask(\n            schedule: ScheduleTaskInput!\n        ): ScheduleTask @auth\n\n        updateChatStatus (\n            participants: ParticipantsInput\n            payload: ChatStatus!\n        ): Message\n        updateMessageStatus(\n            id: Int,\n            messageId: String,\n        ): Message @auth\n        updateStore (\n            storeId: Int!\n            payload: StoreInput!\n        ): Store @auth\n        updateMpesa (\n            mpesaId: Int!\n            payload: MpesaSettingInput!\n        ): MpesaSetting @auth\n        updateBrand (\n            brandId: Int!\n            payload: BrandInput!\n        ): Brand @auth\n        updateBillboard (\n            billboardId: Int!\n            payload: BillboardInput!\n        ): Billboard @auth\n        updateCategory (\n            categoryId: Int!\n            payload: CategoryInput!\n        ): Category @auth\n        updateProduct (\n            productId: Int!\n            payload: ProductInput!\n        ): Product @auth\n        updateProductVariation (\n            productId: Int!\n            payload: ProductInput!\n        ): Product @auth\n        updateOrderCheckout (\n            orderId: Int!\n            storeId: Int!\n            payload: OrderCheckoutInput!\n        ): Order\n        updateCustomer (\n            customerId: Int!\n            payload: CustomerInput!\n        ): Customer @auth\n        updateBulkTemplateTask(\n            taskId: Int!\n            merchantId: Int!\n        ): Response\n\n        deleteStore (\n            storeId: Int!\n        ): Response @auth\n        deleteMpesa (\n            storeId: Int!\n            mpesaId: Int!\n        ): Response @auth\n        deleteBrand (\n            brandId: Int!\n            storeId: Int!\n        ): Response @auth\n        deleteBillboard (\n            storeId: Int!\n            billboardId: Int!\n        ): Response @auth\n        deleteCategory (\n            categoryId: Int!\n            storeId: Int!\n        ): Response @auth\n        deleteProduct(\n            productId: Int!\n            storeId: Int!\n        ): Response @auth\n        deleteImage(\n            imageId: Int!\n            productId: Int!\n        ): Response @auth\n\n        loginMerchant (\n            username: String!\n            password: String!\n        ): Auth\n        signupMerchant (\n            username: String!\n            password: String!\n            whatsapp_phone_number: String!\n            email: String\n        ): Auth\n        logoutMerchant: Response\n\n        ######### Adding Promotion ###########\n        #### Coupon\n        addCoupon (\n            promotion: CouponPromInput\n        ): Promotion @auth\n        updateCoupon(\n            promotionId: Int\n            payload: CouponPromInput\n        ): Promotion @auth\n        deleteCoupon(\n            promotionId: Int!\n            storeId: Int!\n        ): String @auth\n\n        #### Discount\n        addDiscount (\n            discount: DiscountPromInput\n        ): Promotion @auth\n        updateDiscount(\n            promotionId: Int\n            payload: DiscountPromInput\n        ): Promotion @auth\n        deleteDiscount(\n            promotionId: Int!\n            storeId: Int!\n        ): String @auth\n    } \n\n    type ChatUpdated { \n        message: Message\n        chat: Chat \n    } \n   \n    type RootSubscription {\n        chatAdded(merchantId: Int!): Chat # when a new chat is created\n        messageAdded(chatId: Int!): ChatUpdated  # the channel client to subscribe to messageAdded\n    }\n\n    schema { \n        query: RootQuery\n        mutation: RootMutation\n        subscription: RootSubscription\n    }\n"]},851:(e,t,n)=>{var r=n(6617),a=n(8714);e.exports=function(e){return{subscriptions:a(e),graphql:r.server(e)}}},8714:(e,t,n)=>{var r=n(7738),a=n(8063),o=n(5564),s=n(829),i=n(7898),c=n(6854),u=n(2511),d=(n(3672),n(5963).makeExecutableSchema),p=n(5086).WebSocketServer,l=n(7205).useServer;n(818).config();var m=process.env.JWT_SECRET;e.exports=function(e){return function(t){var n,h=d({typeDefs:c,resolvers:i.call(e),schemaDirectives:{auth:u}}),f=new p({server:t,path:"/subscriptions"});l({schema:h,onConnect:(n=o(r.mark((function t(n){var o,i,c;return r.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=n.connectionParams.Authorization,"undefined"===a(o)){t.next=8;break}return i=new RegExp("Bearer","ig"),c=o.replace(i,"").trim(),t.abrupt("return",s.verify(c,m,(function(t,r){if(t)throw new Error("Missing authentication!".bgGreen);return e.db.db.models.Merchant.findByPk(r.id).then((function(e){return n.extra.merchant=e,{merchant:e}}))})));case 8:throw new Error("Missing auth token😫😭".bgRed);case 9:case"end":return t.stop()}}),t)}))),function(e){return n.apply(this,arguments)}),context:function(e){var t=e.extra;return t.request,{merchant:t.merchant}},onDisconnect:function(e,t,n){console.info("Disconnected from the websocket subscriptions".red)}},f)}}},1255:(e,t,n)=>{var r=n(7738),a=n(5564),o=(n(9113),n(3236)),s=o.saveTextMessageToDB,i=o.saveImageMessageToDB,c=o.saveDocumentMessageToDB,u=o.saveVideoMessageToDB,d=o.updateChatStatus,p=o.saveReplyToButtonMessage,l=o.saveReplyToListMessage,m=o.saveReplyToTemplateMessage;function h(){return(h=a(r.mark((function e(t){var n,a,o,h,f,g,I,v,y,b,w,x,E,T,k,S,R,M,N,O,C,A,D,P,_,B,G,q,L;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query.username,a={mer_username:n,customer:{phone_number:void 0}},o={contextMessage:void 0,message:void 0,participants:void 0},!(h=(h=t.body).entry)[0].changes[0].value){e.next=163;break}if(!(f=h[0].changes[0].value).statuses){e.next=18;break}I=f.statuses,console.log(I),console.log(I[0].errors),console.log("############STATUS OF THE SENT MESSAGE############"),a.customer.phone_number=null===(g=I[0])||void 0===g?void 0:g.recipient_id;try{d({participants:a,payload:{status:I[0].status,messageId:null===(v=I[0])||void 0===v?void 0:v.id}})}catch(e){console.log(e)}I[0].conversation&&(console.log("MEE conversation>>>>: ",I[0].conversation),console.log("MSG conversation ID>: ",I[0].conversation.id),console.log("MSG conExp ",I[0].conversation.expiration_timestamp)),I[0].pricing&&(console.log("MSG PRICING>>>>>>>>>: ",I[0].pricing),console.log("MSG PRICING MODEL>>>: ",I[0].pricing.pricing_model),console.log("MSG PRICING CATEGORY: ",I[0].pricing.category)),e.next=163;break;case 18:if(!f.messages){e.next=163;break}if(y={message:{}},b={},console.log("############RECEIVING A MESSAGE FROM CUSTOMER#############"),w=f.messages,console.log(w),w[0].context&&(x=w[0].context,o.contextMessage={messageId:x.id}),b.phone_number=w[0].from,a.customer=b,o.participants=a,y.message.from_customer=!0,y.message.timestamp=(new Date).getTime(),y.message.messageId=w[0].id,y.message.status="delivered","text"!==(E=w[0].type)){e.next=48;break}return T={body:w[0].text.body},y.message.type="TEXT",y.text=T,o.message=y,e.prev=38,e.next=41,s(o);case 41:e.next=46;break;case 43:e.prev=43,e.t0=e.catch(38),console.log("could not save the message to database");case 46:e.next=163;break;case 48:if("interactive"!==E){e.next=86;break}if(y.message.type="BUTTON_REPLY",console.log("$$$$$$ AN INTERACTIVE TYPE MESSAGE from interactive button $$$$$$$$$"),"button_reply"!==(k=w[0].interactive).type){e.next=68;break}return console.log("$$$$$$ A BUTTON INTERACTIVE TYPE"),S=k.button_reply,R={buttonId:S.id,title:S.title},y.mesBtnReply=R,o.message=y,e.prev=58,e.next=61,p(o);case 61:e.next=66;break;case 63:e.prev=63,e.t1=e.catch(58),console.log("could not save the message to database");case 66:e.next=84;break;case 68:if("list_reply"!==k.type){e.next=84;break}return y.message.type="LIST_REPLY",console.log("$$$$$$ A LIST INTERACTIVE TYPE"),M=k.list_reply,N={buttonId:M.id,title:M.title,description:M.description},y.mesListReply=N,o.message=y,console.log(o),e.prev=76,e.next=79,l(o);case 79:e.next=84;break;case 81:e.prev=81,e.t2=e.catch(76),console.log("could not save the message to database");case 84:e.next=163;break;case 86:if("button"!==E){e.next=105;break}return y.message.type="TEMP_REPLY",console.log("$$$$$$ AN BUTTON TYPE MESSAGE from template $$$$$$$$$"),console.log("Interactive>>>>>>>: ",w[0].button),O=w[0].button,C={text:O.text,payload:O.payload},y.mesTempReply=C,o.message=y,console.log("THE PAYLOAD",o),e.prev=95,e.next=98,m(o);case 98:e.next=103;break;case 100:e.prev=100,e.t3=e.catch(95),console.log("could not save the message to database");case 103:e.next=163;break;case 105:if("image"!==E){e.next=124;break}return console.log("$$$$$$$$ AN IMAGE TYPE MESSAGE $$$$$$$$$$"),A=w[0].image,D={url:"https://res.cloudinary.com/dzeeuz5g6/image/upload/v1702201840/qa9iszb4ebczgxffka5n.jpg",imageId:A.id,sha256:A.sha256,mimeType:A.mime_type},A.caption&&(D.caption=A.caption),y.message.type="IMAGE",y.image=D,console.log(y),o.message=y,e.prev=114,e.next=117,i(o);case 117:e.next=122;break;case 119:e.prev=119,e.t4=e.catch(114),console.log("could not save the message to database");case 122:e.next=163;break;case 124:if("document"!==E){e.next=143;break}return console.log("$$$$$$$$ AN DOCUMENT TYPE MESSAGE $$$$$$$$$$"),P=w[0].document,_={url:"https://cloud.appwrite.io/v1/storage/buckets/657c8507c305096354f8/files/657e55198a707f669611/download?project=657c827f1c5737986d84",documentId:P.id,filename:P.filename,mimeType:P.mime_type,sha256:P.sha256},P.caption&&(_.caption=P.caption),y.message.type="DOCUMENT",y.document=_,console.log(_),o.message=y,e.prev=133,e.next=136,c(o);case 136:e.next=141;break;case 138:e.prev=138,e.t5=e.catch(133),console.log("could not save the message to database");case 141:e.next=163;break;case 143:if("video"!==E){e.next=162;break}return console.log("$$$$$$$$ AN VIDEO TYPE MESSAGE $$$$$$$$$$"),B=w[0].video,G={url:"",videoId:B.id,mimeType:B.mime_type,sha256:B.sha256},B.caption&&(G.caption=B.caption),y.message.type="VIDEO",y.video=G,console.log(G),o.message=y,e.prev=152,e.next=155,u(o);case 155:e.next=160;break;case 157:e.prev=157,e.t6=e.catch(152),console.log("could not save the message to database");case 160:e.next=163;break;case 162:"audio"===E?(console.log("$$$$$$$$ AN audio TYPE MESSAGE $$$$$$$$$$"),q=w[0].audio,console.log("audio mime_type>: ",q.mime_type),console.log("audio sha256>>>>>: ",q.sha256),console.log("audio id>>>>>>>>>: ",q.id),console.log("audio is voicd",q.voice)):"location"===E&&(console.log("$$$$$$$$ A Location TYPE MESSAGE $$$$$$$$$$"),L=w[0].location,console.log(L),console.log("location address>: ",L.address),console.log("location latitude>>>>>: ",L.latitude),console.log("location name>>>>>>>>>: ",L.name),console.log("location url",L.url));case 163:case"end":return e.stop()}}),e,null,[[38,43],[58,63],[76,81],[95,100],[114,119],[133,138],[152,157]])})))).apply(this,arguments)}t&&(t.getPayload=function(e){return h.apply(this,arguments)})},8059:(e,t,n)=>{n(818).config();var r=new(0,n(2369).GraphQLClient)("".concat(process.env.GRAPHQLURI,"/graphql"),{headers:{"content-type":"application/json"}});e.exports=r},8780:(e,t)=>{t&&(t.interactiveList={messaging_product:"whatsapp",recipient_type:"individual",to:"PHONE_NUMBER",type:"interactive",interactive:{type:"list",header:{type:"text",text:"Add an Item to Existing Pending Order"},body:{text:"View our list of produce to add to your existing order. Hurry before your order is out for delivery!"},footer:{text:"Markt online groceries"},action:{button:"Products List",sections:[{title:"Fresh Produce",rows:[{id:"SECTION_1_ROW_1_ID",title:"SECTION_1_ROW_1_TITLE",description:"SECTION_1_ROW_1_DESCRIPTION"},{id:"SECTION_1_ROW_2_ID",title:"SECTION_1_ROW_2_TITLE",description:"SECTION_1_ROW_2_DESCRIPTION"}]},{title:"Fresh Produce Cont",rows:[]}]}}},t.interactiveReplyButton={messaging_product:"whatsapp",recipient_type:"individual",to:"PHONE_NUMBER",type:"interactive",interactive:{type:"button",body:{text:"Do you want to add an item to your order?"},action:{buttons:[{type:"reply",reply:{id:"0",title:"No"}},{type:"reply",reply:{id:"1",title:"Yes"}}]}}})},6919:(e,t,n)=>{var r=n(7738),a=n(5564),o=(n(3672).colors,n(8938)),s=n(4104),i=process.env.access_token,c=process.env.api_version,u=(process.env.phone_number,process.env.phone_number_id),d=process.env.business_account_id,p={};function l(){return(l=a(r.mark((function e(t,n){var a,s;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={method:"post",url:"https://graph.facebook.com/".concat(n.api_version,"/").concat(n.phone_number_id,"/messages"),headers:{Authorization:"Bearer ".concat(n.access_token),"Content-Type":"application/json"},data:JSON.stringify(t)},e.prev=1,e.next=4,o(a);case 4:return s=e.sent,e.abrupt("return",s);case 8:if(e.prev=8,e.t0=e.catch(1),console.log("An error occured while sending message ".concat(e.t0.message).bgRed,e.t0.response.data),"131030"!==e.t0.code){e.next=14;break}return console.log("Recipient phone number not in allowed list: Add recipient phone number to recipient list and try again.".bgRed),e.abrupt("return");case 14:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function m(){return(m=a(r.mark((function e(t){var n;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={method:"put",url:"https://graph.facebook.com/".concat(c,"/").concat(u,"/messages"),headers:{Authorization:"Bearer ".concat(i),"Content-Type":"application/json"},data:t},e.next=3,o(n);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(){return(h=a(r.mark((function e(){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o({method:"get",url:"https://graph.facebook.com/".concat(c,"/").concat(d,"/message_templates")+"?limit=1000",headers:{Authorization:"Bearer ".concat(i),"Content-Type":"application/json"}});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function f(){return(f=a(r.mark((function e(t){var n;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Sending a request to whatsapp to createMessageTemplate  name:"+process.env.TEMPLATE_NAME_PREFIX+"_"+t.name),n={method:"post",url:"https://graph.facebook.com/".concat(c,"/").concat(d,"/message_templates"),headers:{Authorization:"Bearer ".concat(i),"Content-Type":"application/json"},data:{name:process.env.TEMPLATE_NAME_PREFIX+"_"+t.name,category:t.category,components:t.components,language:t.language}},e.next=4,o(n);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}e.exports={sendWhatsAppMessage:function(e,t){return l.apply(this,arguments)},updateWhatsAppMessage:function(e){return m.apply(this,arguments)},listTemplates:function(){return h.apply(this,arguments)},createMessageTemplate:function(e){return f.apply(this,arguments)},getMessageData:function(e,t){var n,r=s[t.statusId-1];switch(r.name){case"welcome":n=[{type:"text",text:t.customer.split(" ")[0]}];break;case"payment_analysis":n=[{type:"text",text:t.customer.split(" ")[0]},{type:"text",text:p[t.items[0].productId-1].name}];break;case"payment_approved":n=[{type:"text",text:t.customer.split(" ")[0]},{type:"text",text:t.id},{type:"text",text:t.deliveryDate}];break;case"invoice_available":n=[{type:"text",text:t.customer.split(" ")[0]},{type:"text",text:p[t.items[0].productId-1].name},{type:"text",text:"https://customer.your-awesome-grocery-store-demo.com/my-account/orders/".concat(t.id)}];break;case"order_picked_packed":n=[{type:"text",text:t.customer.split(" ")[0]},{type:"text",text:t.id},{type:"text",text:"https://customer.your-awesome-grocery-store-demo.com/my-account/orders/".concat(t.id)}];break;case"order_in_transit":n=[{type:"text",text:t.customer.split(" ")[0]},{type:"text",text:t.id},{type:"text",text:t.deliveryDate},{type:"text",text:"https://customer.your-awesome-grocery-store-demo.com/my-account/orders/".concat(t.id)}];break;case"order_delivered":n=[{type:"text",text:t.customer.split(" ")[0]},{type:"text",text:t.id},{type:"text",text:t.deadlineDays}]}var a={messaging_product:"whatsapp",to:e,type:"template",template:{name:process.env.TEMPLATE_NAME_PREFIX+"_"+r.name,language:{code:"en_US"},components:[{type:"body",parameters:n}]}};return JSON.stringify(a)},createProductsList:function(e){return{id:"".concat(e.id),title:e.name,description:"$".concat(e.price)}}}},9173:(e,t)=>{t&&(t.messageStatuses={read:{messaging_product:"whatsapp",status:"read",message_id:""},sent:{messaging_product:"whatsapp",status:"sent",message_id:""}})},4104:(e,t)=>{t&&(t.messageTemplates=[{name:"welcome",category:"UTILITY",components:[{type:"BODY",text:"Hi, {{1}}! How great to have you here 😃\n\nNow, as soon as you buy with us, you will receive automatic messages about the progress of your order here.\n\nAnd whenever you want, you can ask about your latest orders, our offer of the day or the addresses and opening hours of our physical stores.",example:{body_text:[["Bob"]]}}],language:"en_US",modelFields:["firstName"]},{name:"payment_analysis",category:"UTILITY",components:[{type:"BODY",text:"Hello, {{1}}!\n\nThank you for shopping with us ❤️\n\nWe received the order for the product {{2}} and now we are just waiting for the payment to be approved.\n\nTo know about your purchase anytime, just send a message here and we'll tell you :)",example:{body_text:[["Bob","Olive Oil"]]}}],language:"en_US",modelFields:["firstName","productName"]},{name:"payment_approved",category:"UTILITY",components:[{type:"BODY",text:"Hello, {{1}}!\n\nPayment for order {{2}} has been approved ❤️\n\nWe are working to have your order delivered by {{3}}.",example:{body_text:[["Bob","02-953022600","June 9"]]}}],language:"en_US",modelFields:["firstName","orderNumber","deliveryDate"]},{name:"invoice_available",category:"UTILITY",components:[{type:"BODY",text:"Hello, {{1}}!\n\nYou can download the invoice for the product {{2}} here: {{3}}.",example:{body_text:[["Bob","OLIVE OIL","https://customer.your-awesome-grocery-store-demo.com/my-account/orders/02-953022600"]]}}],language:"en_US",modelFields:["firstName","productName","orderUrl"]},{name:"order_picked_packed",category:"UTILITY",components:[{type:"BODY",text:"Hello, {{1}}!\n\nOrder {{2}} has already been picked and packed 📦\n\nAnd it's ready to get to you soon.\n\nIf you want to track shipping, it's here 👉 {{3}}",example:{body_text:[["Bob","02-950515063","https://customer.your-awesome-grocery-store-demo.com/my-account/orders/02-953022600"]]}}],language:"en_US",modelFields:["firstName","orderNumber","orderUrl"]},{name:"order_in_transit",category:"UTILITY",components:[{type:"BODY",text:"Hello {{1}}, your order {{2}} is already on its way and will be delivered to you on {{3}} :)\n\nIf you don't have a way to get it, let someone close to receive it for you, okay?\n\nYou can also track the shipment anytime here 👉 {{4}}",example:{body_text:[["Bob","02-950515063","June 09","https://customer.your-awesome-grocery-store-demo.com/my-account/orders/02-953022600"]]}}],language:"en_US",modelFields:["firstName","orderNumber","deliveryDate","orderUrl"]},{name:"order_delivered",category:"UTILITY",components:[{type:"BODY",text:"Hello {{1}}, order {{2}} has been delivered!\n\nEnjoy it! 🎉\n\nIf you have any problems and want to exchange or return, the deadline is {{3}} calendar days. To order, just enter the My Account section of the website or app, find the product(s) in My Orders and click on exchange or return. We only do not exchange if there are signs that the product has been used, such as damaged labels and broken seals, ok?\n\nThanks for shopping with us!\n\nSee you later 👋",example:{body_text:[["Bob","02-950515063","7"]]}}],language:"en_US",modelFields:["firstName","orderNumber","deadlineDays"]}])},8430:(e,t,n)=>{var r=n(7738),a=n(5564),o=n(8780),s=o.interactiveList,i=o.interactiveReplyButton,c=n(6919),u=c.createProductsList,d=(c.updateWhatsAppMessage,c.sendWhatsAppMessage,[{id:1,name:"assorted berries",thumbnail:"2010/12/13/10/05/berries-2277__340.jpg",price:2.99},{id:2,name:"tomato",thumbnail:"2014/04/10/11/06/tomatoes-320860__340.jpg",price:1.99},{id:3,name:"oranges",thumbnail:"2017/01/20/15/06/oranges-1995056__340.jpg",price:3.99},{id:4,name:"cherries",thumbnail:"2016/06/18/22/36/cherries-1465801__340.jpg",price:2.99},{id:5,name:"pistacchio",thumbnail:"2018/03/13/20/08/pistachios-3223610__340.jpg",price:5.99},{id:6,name:"carrots",thumbnail:"2017/06/09/16/39/carrots-2387394__340.jpg",price:2.99},{id:7,name:"onions",thumbnail:"2016/05/16/22/47/onions-1397037__340.jpg",price:1.99},{id:8,name:"potatoes",thumbnail:"2014/08/06/20/32/potatoes-411975__340.jpg",price:1.99},{id:9,name:"broccoli",thumbnail:"2015/03/14/13/59/vegetables-673181__340.jpg",price:3.99},{id:10,name:"coffee",thumbnail:"2016/08/07/16/23/coffee-1576537__340.jpg",price:3.99},{id:11,name:"salmon",thumbnail:"2016/03/05/19/02/salmon-1238248__340.jpg",price:5.99},{id:12,name:"sausages",thumbnail:"2018/07/08/20/18/sausages-3524649__340.jpg",price:3.99},{id:13,name:"chicken wings",thumbnail:"2016/07/31/17/51/chicken-1559548__340.jpg",price:5.99},{id:14,name:"brie",thumbnail:"2015/02/10/02/42/cheese-630511__340.jpg",price:7.99},{id:15,name:"rice",thumbnail:"2019/02/15/03/28/rice-3997767__340.jpg",price:4.99},{id:16,name:"blonde ale beer",thumbnail:"2017/01/21/21/15/beer-1998293__340.jpg",price:3.99}]);function p(){return(p=a(r.mark((function e(t,n){var a,o,c,p;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.from,"text"===(a=t.type)){t.text.body;try{i.to=n.phone_number}catch(e){console.log("ERROR SENDING THE REPLY buttons",e)}}else if("interactive"===a)if("button_reply"===(o=t.interactive.type)){if(c=t.interactive.button_reply.id,t.interactive.button_reply.title,console.log("BUTTON ID###############",c),1==c)try{(p=s).to=n.phone_number,p.interactive.action.sections[0].rows=d.map(u),p.interactive.action.sections[0].rows.length=10}catch(e){console.log("ERROR SENGING THE LIST################",e.message)}}else"list_reply"===o&&(t.interactive.list_reply.id,t.interactive.list_reply.title,t.interactive.list_reply.description);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}e.exports=function(e,t){return p.apply(this,arguments)}},3236:(e,t,n)=>{var r,a,o,s,i,c,u,d,p=n(7738),l=n(5564),m=n(4979),h=n(8059),f=n(2369).gql,g=f(r||(r=m(["\n  mutation AddTextMessage(\n    $message: TextMessageInput!\n    $participants: ParticipantsInput\n    $contextMessage: ContextMessageInput\n  ) {\n    addTextMessage(\n      message: $message\n      participants: $participants\n      contextMessage: $contextMessage\n    ) {\n      id\n    }\n  }\n"]))),I=f(a||(a=m(["\n  mutation AddImageMessage(\n    $message: ImageMessageInput!\n    $participants: ParticipantsInput\n    $contextMessage: ContextMessageInput\n  ) {\n    addImageMessage(\n      message: $message\n      participants: $participants\n      contextMessage: $contextMessage\n    ) {\n      id\n    }\n  }\n"]))),v=f(o||(o=m(["\n  mutation AddDocumentMessage(\n    $message: DocumentMessageInput!\n    $participants: ParticipantsInput\n    $contextMessage: ContextMessageInput\n  ) {\n    addDocumentMessage(\n      message: $message\n      participants: $participants\n      contextMessage: $contextMessage\n    ) {\n      __typename\n      id\n    }\n  }\n"]))),y=f(s||(s=m(["\n  mutation AddVideoMessage(\n    $message: VideoMessageInput!\n    $participants: ParticipantsInput\n    $contextMessage: ContextMessageInput\n  ) {\n    addVideoMessage(\n      message: $message\n      participants: $participants\n      contextMessage: $contextMessage\n    ) {\n      id\n    }\n  }\n"]))),b=f(i||(i=m(["\n    mutation AddButtonRepliedMessage($message: ButtonRepliedInput!, $participants: ParticipantsInput, $contextMessage: ContextMessageInput) {\n    addButtonRepliedMessage(message: $message, participants: $participants, contextMessage: $contextMessage) {\n        id \n    }\n  }\n"]))),w=f(c||(c=m(["\n      mutation AddTemplateRepliedMessage($message: TemplateRepliedInput!, $participants: ParticipantsInput, $contextMessage: ContextMessageInput) {\n    addTemplateRepliedMessage(message: $message, participants: $participants, contextMessage: $contextMessage) {\n         __typename\n        id\n    }\n  }\n"]))),x=f(u||(u=m(["\n     mutation addListRepliedMessage($message: ListRepliedInput!, $participants: ParticipantsInput, $contextMessage: ContextMessageInput) {\n    addListRepliedMessage(message: $message, participants: $participants, contextMessage: $contextMessage) {\n        id\n    }\n  }\n"]))),E=f(d||(d=m(["\n  mutation updateChatStatus(\n    $participants: ParticipantsInput!\n    $payload: ChatStatus!\n  ) {\n    updateChatStatus(participants: $participants, payload: $payload) {\n      id\n    }\n  }\n"])));function T(){return(T=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,console.log("saveTextMessageToDB",t),e.prev=2,e.next=5,h.request(g,n);case 5:return e.sent,e.abrupt("return");case 9:e.prev=9,e.t0=e.catch(2),console.log("there was an error saving to the database",e.t0);case 12:case"end":return e.stop()}}),e,null,[[2,9]])})))).apply(this,arguments)}function k(){return(k=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,console.log("saveImageMessageToDB",t),e.prev=2,e.next=5,h.request(I,n);case 5:return e.sent,e.abrupt("return");case 9:e.prev=9,e.t0=e.catch(2),console.log("there was an error saving to the database",e.t0);case 12:case"end":return e.stop()}}),e,null,[[2,9]])})))).apply(this,arguments)}function S(){return(S=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.prev=1,e.next=4,h.request(v,n);case 4:return e.sent,e.abrupt("return");case 8:e.prev=8,e.t0=e.catch(1),console.log("there was an error saving to the database",e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function R(){return(R=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.prev=1,e.next=4,h.request(y,n);case 4:return e.sent,e.abrupt("return");case 8:e.prev=8,e.t0=e.catch(1),console.log("there was an error saving to the database",e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function M(){return(M=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.prev=1,e.next=4,h.request(b,n);case 4:return e.sent,e.abrupt("return");case 8:e.prev=8,e.t0=e.catch(1),console.log("there was an error saving to the database",e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function N(){return(N=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.prev=1,e.next=4,h.request(w,n);case 4:return e.sent,e.abrupt("return");case 8:e.prev=8,e.t0=e.catch(1),console.log("there was an error saving to the database",e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function O(){return(O=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.prev=1,e.next=4,h.request(x,n);case 4:return e.sent,e.abrupt("return");case 8:e.prev=8,e.t0=e.catch(1),console.log("there was an error saving to the database",e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function C(){return(C=l(p.mark((function e(t){var n;return p.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.prev=1,e.next=4,h.request(E,n);case 4:return e.sent,e.abrupt("return");case 8:e.prev=8,e.t0=e.catch(1),console.log("there was an error saving to the database",e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}t&&(t.saveTextMessageToDB=function(e){return T.apply(this,arguments)},t.saveImageMessageToDB=function(e){return k.apply(this,arguments)},t.updateChatStatus=function(e){return C.apply(this,arguments)},t.saveDocumentMessageToDB=function(e){return S.apply(this,arguments)},t.saveVideoMessageToDB=function(e){return R.apply(this,arguments)},t.saveReplyToButtonMessage=function(e){return M.apply(this,arguments)},t.saveReplyToListMessage=function(e){return O.apply(this,arguments)},t.saveReplyToTemplateMessage=function(e){return N.apply(this,arguments)})},3963:(e,t,n)=>{var r={"./ad.js":8412,"./adtemplate.js":718,"./billboard.js":354,"./brand.js":3620,"./bulktemplatetask.js":7190,"./buttonrepliedaction.js":8438,"./buttonreplyaction.js":6171,"./category.js":205,"./chat.js":491,"./conversation.js":6002,"./coupon.js":2171,"./customer.js":1469,"./documentmessage.js":9673,"./image.js":980,"./imageheader.js":9921,"./imagemessage.js":9833,"./interactivebutton.js":5117,"./interactivelist.js":2193,"./interactivemessage.js":8194,"./interactivetemplate.js":2163,"./listrepliedaction.js":3002,"./listrowbutton.js":8525,"./listsection.js":226,"./locationmessage.js":6007,"./loyalty.js":8783,"./marketingresponse.js":4674,"./merchant.js":3785,"./message.js":3050,"./mpesasetting.js":1849,"./order.js":6125,"./orderitem.js":5682,"./product.js":1506,"./productcombination.js":5611,"./productimage.js":3769,"./productvariant.js":9597,"./productvariation.js":3285,"./productvariationoption.js":8084,"./promotion.js":7760,"./promotioncustomer.js":2804,"./promotionproduct.js":9901,"./purchase.js":642,"./redemption.js":2336,"./reward.js":294,"./route.js":9248,"./sale.js":3514,"./saledetail.js":7183,"./scheduletask.js":2297,"./setting.js":4921,"./store.js":9512,"./templaterepliedaction.js":1896,"./templatereplyaction.js":1757,"./textheader.js":7587,"./textmessage.js":5487,"./videomessage.js":5167};function a(e){var t=o(e);return n(t)}function o(e){if(!n.o(r,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return r[e]}a.keys=function(){return Object.keys(r)},a.resolve=o,e.exports=a,a.id=3963},6299:e=>{"use strict";e.exports=require("@apollo/server")},4772:e=>{"use strict";e.exports=require("@apollo/server/express4")},3133:e=>{"use strict";e.exports=require("@apollo/server/plugin/drainHttpServer")},5564:e=>{"use strict";e.exports=require("@babel/runtime/helpers/asyncToGenerator")},5998:e=>{"use strict";e.exports=require("@babel/runtime/helpers/classCallCheck")},8898:e=>{"use strict";e.exports=require("@babel/runtime/helpers/createClass")},1116:e=>{"use strict";e.exports=require("@babel/runtime/helpers/defineProperty")},9285:e=>{"use strict";e.exports=require("@babel/runtime/helpers/getPrototypeOf")},2750:e=>{"use strict";e.exports=require("@babel/runtime/helpers/inherits")},4433:e=>{"use strict";e.exports=require("@babel/runtime/helpers/objectDestructuringEmpty")},2462:e=>{"use strict";e.exports=require("@babel/runtime/helpers/objectWithoutProperties")},6609:e=>{"use strict";e.exports=require("@babel/runtime/helpers/possibleConstructorReturn")},4979:e=>{"use strict";e.exports=require("@babel/runtime/helpers/taggedTemplateLiteral")},8063:e=>{"use strict";e.exports=require("@babel/runtime/helpers/typeof")},7738:e=>{"use strict";e.exports=require("@babel/runtime/regenerator")},5963:e=>{"use strict";e.exports=require("@graphql-tools/schema")},6921:e=>{"use strict";e.exports=require("@graphql-tools/utils")},8938:e=>{"use strict";e.exports=require("axios")},5486:e=>{"use strict";e.exports=require("bcrypt")},3268:e=>{"use strict";e.exports=require("body-parser")},3672:e=>{"use strict";e.exports=require("colors")},7174:e=>{"use strict";e.exports=require("compression")},6898:e=>{"use strict";e.exports=require("cookie-parser")},2363:e=>{"use strict";e.exports=require("cookies")},8577:e=>{"use strict";e.exports=require("cors")},818:e=>{"use strict";e.exports=require("dotenv")},7252:e=>{"use strict";e.exports=require("express")},1253:e=>{"use strict";e.exports=require("graphql")},2369:e=>{"use strict";e.exports=require("graphql-request")},3946:e=>{"use strict";e.exports=require("graphql-subscriptions")},7205:e=>{"use strict";e.exports=require("graphql-ws/lib/use/ws")},6140:e=>{"use strict";e.exports=require("http-errors")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},4716:e=>{"use strict";e.exports=require("moment")},2096:e=>{"use strict";e.exports=require("morgan")},9031:e=>{"use strict";e.exports=require("sequelize")},5124:e=>{"use strict";e.exports=require("winston")},5086:e=>{"use strict";e.exports=require("ws")},9113:e=>{"use strict";e.exports=require("x-hub-signature")},8611:e=>{"use strict";e.exports=require("http")},6928:e=>{"use strict";e.exports=require("path")}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e=n(7738),t=n(8063),r=n(5564),a=n(7252),o=(n(6140),n(6928)),s=n(6898),i=n(2096),c=n(3268),u=n(8577),d=n(4772).expressMiddleware,p=n(7174);n(818).config();var l=n(2363),m=n(829),h=n(8611).createServer,f=n(7906),g=n(8488),I=n(919),v=n(851),y=n(3482),b=a(),w=process.env.LISTEN_PORT||4e3,x=process.env.JWT_SECRET,E=h(b),T=["http://localhost:3000","http://localhost:3000","http://cesNextClient:3000","https://graph.facebook.com","https://hello-customer.onrender.com"],k={origin:function(e,t){return e&&-1===T.indexOf(e)?t(new Error("The CORS policy for this site does not allow access from the specified Origin."),!1):t(null,!0)},credentials:!0};b.use(u(k)),b.use((function(e,t,n){var r={keys:["".concat(process.env.COOKIE_SIGNATURE)]};e.cookies=new l(e,t,r),n()}));var S={db:y},R=c.json;b.use(p()),b.use(c.json({verify:function(e,t,n){e.rawBody=n}})),b.set("views",o.join(__dirname,"views")),b.set("view engine","ejs"),b.use(i("dev")),b.use(a.json()),b.use(a.urlencoded({extended:!1})),b.use(s());var M=v(S);function N(){return N=r(e.mark((function n(){var a,o,s;return e.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:a=Object.keys(M),o=e.mark((function n(){var o,i;return e.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o=a[s],n.t0=o,n.next="graphql"===n.t0?4:"subscriptions"===n.t0?9:11;break;case 4:return i=M.graphql,n.next=7,i.start();case 7:return b.use("/graphql",u(k),R(),d(i,{context:function(){var n=r(e.mark((function n(r){var a,o,s,i;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r.req,o=a.headers.authorization,"undefined"===t(o)){e.next=11;break}return s=new RegExp("Bearer ","ig"),i=o.replace(s,"").trim(),console.log("From cookies".bgBlue,a.cookies.get("authorization",{signed:!0})),console.log("TOKEN$$$$$$$$$$$$$$$$$".bgBlue,i),e.abrupt("return",m.verify(i,x,(function(e,t){return e?a:S.db.db.models.Merchant.findByPk(t.id).then((function(e){return Object.assign({},a,{merchant:e})}))})));case 11:return e.abrupt("return",a);case 12:case"end":return e.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()})),n.abrupt("break",13);case 9:console.log("SUBSCRIPTION SERVICES"),E.listen(w,(function(){console.log("🚀 Server ready at http://localhost:".concat(w,"/graphql")),console.log("subscription",M[o]),M[o](E)}));case 11:return b.use("/${name}",M[o]),n.abrupt("break",13);case 13:case"end":return n.stop()}}),n)})),s=0;case 3:if(!(s<a.length)){n.next=8;break}return n.delegateYield(o(),"t0",5);case 5:s+=1,n.next=3;break;case 8:case"end":return n.stop()}}),n)}))),N.apply(this,arguments)}!function(){N.apply(this,arguments)}(),b.use("/createTemplates",f),b.use("/incoming",g),b.use("/payment",I),b.use((function(e,t,n,r){n.locals.message=e.message,n.locals.error="development"===t.app.get("env")?e:{},n.status(e.status||500),n.render("error")}))})()})();